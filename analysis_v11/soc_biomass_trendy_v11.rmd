---
title: "SOC-litter input-biomass relationship in DGVMs"
author: "huanyuan zhang-zheng"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
# output:
#   pdf_document:
#     toc: true
#     toc_depth: 2
---

```{r}
library(tidyverse)
rm(list=ls())
#setwd("~/E/RA/DGVM_density_plot/trendy_v9") #h
setwd('F:/Oxford/Chapter_four/Beni/DGVM_density_plot/trendy_v11/')
```

## Approach

Does (steady-state) SOC storage, simulated in DGVMs, scale with litter inputs? And do litter inputs scale with biomass? To investigate this, we can look at the following relationships:

- The relative enhancement in steady-state SOC vs. the relative enhancement in NPP. $C^\ast$ is the steady-state SOC. It is given by the initial SOC stocks in simulations (spun up to steady state). 
$$
\frac{\Delta C^\ast}{C^\ast} / \frac{\Delta NPP}{NPP_\text{init}}
$$
- The relative enhancement in steady-state SOC vs. the relative enhancement in biomass ($B$).
$$
\frac{\Delta C^\ast}{C^\ast} / \frac{\Delta B}{B_\text{init}}
$$
$\Delta$ is the difference between end and beginning of a transient simulation covering the historical period, where only CO2 changes (hence, soil turnover rates should not change in a typical 1st order kinetics-based SOC model).

Our hypothesis is that these relationships follow the 1:1 line.

$\Delta C^\ast$ cannot be extracted directly from simulations. But it can be estimated from the imbalance between soil respiration and litter input before a steady state is reached:
$$
\tau \approx \frac{C(t)}{\text{NPP}(t) - \Delta C(t)}
$$

Combine this with $\Delta C^\ast=\tau \; \text{NPP}$, to get:
$$
C^\ast = \frac{C(t)}{1 - \frac{\Delta C(t)}{\text{NPP}(t)}}
$$
These variables are extracted from TRENDY S1 simulations as follows:

- $C(t)$: soil C at the end of the simulation (mean over 2008-2017)
- $\Delta C(t)$: Annual change in soil C during the last decade (2008-2017) (`filn_cSoil_change` - MUST BE DIVIDED BY 10!)
- NPP$(t)$: Annual mean NPP during the last decade (2008-2017)

- $\Delta C^\ast$: $C^\ast$ (as defined above) minus soil C during the first decade of the simulation (spun up to steady state)

The same is done with biomass ($B$).


## Process TRENDY v7 files

(Adjust path for `filnams` to select v8 or v7)

From downloaded TRENDY outputs (here, simulation S1: only CO2 is changing), get global fields of: 

1. Multi-annual mean NPP at the beginning of the simulation
2. Multi-annual mean NPP at the end of the simulation
3. Multi-annual mean SOC at the beginning of the simulation
4. Multi-annual mean SOC at the end of the simulation
5. Multi-annual mean biomass at the beginning of the simulation
6. Multi-annual mean biomass at the end of the simulation
7. Change in SOC over a multi-annual period at the end of the simulation (for $\Delta C(t)$)

Simulations should cover 1700-2017 (318 years = time step in NetCDF outputs). But not all do.

- Starting in year 1700: CABLE-POP, CLM5.0, JSBACH, LPX-Bern, LPJ-GUESS, OCN, ORCHIDEE-CNP, SDGVM
- Starting in year 1701: CLASS-CTEM, ISAM, JULES, SURFEX
- Starting in year 1900: DLEM
- Starting in year 1901: ORCHIDEE
- Starting in year 1860: VISIT

Peculiarities of outputs by model prohibiting their processing:

- LPJ: No S1 outputs
- DLEM: failed NPP processing
- LPX-Bern: failed NPP processing
- VISIT: No NPP output available

No separate output for pools (wood, leaf, root)

- CLASS-CTEM
- DLEM
- JSBACH
- JULES
- OCN
- SDGVM (only wood missing, could be derived by `cdo -O sub SDGVM_S1_cVeg.nc SDGVM_S1_cRoot.nc SDGVM_S1_cLeaf.nc`. cWood is then assumed zero: `cdo mulc,0 SDGVM_S1_cLeaf.nc SDGVM_S1_cWood.nc`, and `cdo -O chname,cLeaf,cWood SDGVM_S1_cWood.nc SDGVM_S1_cWood2.nc`, but is not!)
- SURFEX
- VISIT

### Process files: multi-annual mean

Determine for which models we have all the files (cWood and cVeg) to calculate wood mass fractions and create system command.
```{r}
# availvars <- read_csv( "./availvars_trendy_v8_S1.csv" )
# filnams <- read_csv( "filnams_trendy_v8_S1.csv" ) %>% 
filnams <- read_csv( "filnams_trendy_v11_S1.csv" ) %>% 
  setNames(c("modl", paste0("filn_", names(.)[-1])))

modls <- filnams %>% 
  filter(!is.na(filn_cSoil) & !is.na(filn_cVeg) & !is.na(filn_npp)) %>%
  
  ## for separate aboveground biomass
  filter(!is.na(filn_cWood) & !is.na(filn_cLeaf)) %>%
  
  
  pull(modl)

df <- filnams %>% 
  
  ## filter based on above
  filter(modl %in% modls) %>%
  
  # mutate(dir = paste0("/cluster/home/bestocke/data/trendy/v8/")) %>% 
  # mutate(dir = paste0("~/data/trendy/v8/")) %>% 
  mutate(dir = paste0(".")) %>% 
  mutate_at(vars(starts_with("filn")), ~str_replace(., "\\.nc", "")) %>%
  mutate_at(vars(starts_with("filn")), ~str_replace(., "cleaf", "cLeaf")) %>%
  mutate_at(vars(starts_with("filn")), ~str_replace(., "croot", "cRoot")) %>%
  mutate_at(vars(starts_with("filn")), ~str_replace(., "csoil", "cSoil")) %>%
  mutate_at(vars(starts_with("filn")), ~str_replace(., "cveg", "cVeg")) %>%
  mutate_at(vars(starts_with("filn")), ~str_replace(., "cwood", "cWood")) %>%
  mutate_at(vars(starts_with("filn")), ~str_replace(., "cRootf", "cRoot")) %>%
  
  ## get starting year
  left_join(read_csv("startyear_trendy_v11_S1.csv"), by = "modl") %>% 
  rename(startyear_init = startyear, startyear_npp_init = startyear_npp) %>% 
  mutate(endyear_init = startyear_init + 9, endyear_npp_init = startyear_npp_init + 9) %>% 
  
  rowwise() %>% 
  mutate(filn_cVeg_init  = paste0(filn_cVeg, "_INIT_MEAN"),
         filn_cVeg_final = paste0(filn_cVeg, "_FINAL_MEAN"),

         filn_cLeaf_init  = paste0(filn_cLeaf, "_INIT_MEAN"),
         filn_cLeaf_final = paste0(filn_cLeaf, "_FINAL_MEAN"),

         filn_cRoot_init  = paste0(filn_cRoot, "_INIT_MEAN"),
         filn_cRoot_final = paste0(filn_cRoot, "_FINAL_MEAN"),

         filn_cWood_init  = paste0(filn_cWood, "_INIT_MEAN"),
         filn_cWood_final = paste0(filn_cWood, "_FINAL_MEAN"),
         
         filn_cSoil_init  = paste0(filn_cSoil, "_INIT_MEAN"),
         filn_cSoil_final = paste0(filn_cSoil, "_FINAL_MEAN"),
         
         filn_cSoil_change = paste0(filn_cSoil, "_CHANGE"),
         filn_cVeg_change  = paste0(filn_cVeg, "_CHANGE"),
         filn_cLeaf_change = paste0(filn_cLeaf, "_CHANGE"),
         filn_cWood_change = paste0(filn_cWood, "_CHANGE"),
                  
         filn_npp_init  = paste0(filn_npp, "_INIT_MEAN"),
         filn_npp_final = paste0(filn_npp, "_FINAL_MEAN"),
         
         filn_gpp_init  = paste0(filn_gpp, "_INIT_MEAN"),
         filn_gpp_final = paste0(filn_gpp, "_FINAL_MEAN"),
          
         filn_rh_init  = paste0(filn_rh, "_INIT_MEAN"),
         filn_rh_final = paste0(filn_rh, "_FINAL_MEAN"),
         
         filn_cLitter_init  = paste0(filn_cLitter, "_INIT_MEAN"),
         filn_cLitter_final = paste0(filn_cLitter, "_FINAL_MEAN")
         )
```

## Collect data

... into tidy data frame

```{r}
source("collect_gdf_bymodl.R")
source("analyse_modobs2.R")
source("LSD.heatscatter.R")
source("read_nc_onefile.R")
source("nc_to_df.R")
source("df_to_grid.R")
gdf <- purrr::map(

  as.list(seq(nrow(df))),

  ~collect_gdf_bymodl(

    df$modl[.],
    df$dir[.],

    df$filn_cSoil_init[.],
    df$filn_cSoil_final[.],

    df$filn_cVeg_init[.],
    df$filn_cVeg_final[.],

    df$filn_cLeaf_init[.],
    df$filn_cLeaf_final[.],

    df$filn_cRoot_init[.],
    df$filn_cRoot_final[.],

    df$filn_cWood_init[.],
    df$filn_cWood_final[.],

    df$filn_npp_init[.],
    df$filn_npp_final[.],

    df$filn_cSoil_change[.],
    df$filn_cVeg_change[.],
    
    df$filn_gpp_init[.],
    df$filn_gpp_final[.],
    
    df$filn_rh_init[.],
    df$filn_rh_final[.],
    
    df$filn_cLitter_init[.],
    df$filn_cLitter_final[.],
    
    df$filn_landCoverFrac[.]
    )) %>% 
  
  bind_rows() %>%



  group_by(modl) %>%
  nest()
```


## Calculate relationships

```{r}


#                       unit correction                       ~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

### JSBACH (no land cover change map)
model_no<-which(gdf$modl=="JSBACH")
model_df<-gdf$data[[model_no]]
#View(model_df)
robustbase::colMedians(as.matrix(model_df),na.rm = T)
sum(!model_df$landCoverFrac==0)

### CABLE-POP(no land cover change map)
model_no<-which(gdf$modl=="CABLE-POP")
model_df<-gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)

### CABLE-POP(no land cover change map)
model_no<-which(gdf$modl=="CLASSIC")
model_df<-gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)

### CLM5.0 (no land cover change map)
model_no<-which(gdf$modl=="CLM5.0")
model_df<-gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)



### ISAM (no land cover change map)
model_no<-which(gdf$modl=="ISAM")
model_df<-gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)
### LPJ-GUESS (this one land cover frac change)
model_no<-which(gdf$modl=="LPJ-GUESS")
model_df<-gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)

### ORCHIDEE(no land cover change map)
model_no<-which(gdf$modl=="ORCHIDEE")
model_df<-gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)





### CLASSIC(no land cover change map)
model_no<-which(gdf$modl=="ORCHIDEE")
model_df<-gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)

### JULES-ES-1p0 (this one land cover frac change)
model_no<-which(gdf$modl=="JULES")
model_df<-gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)

### LPJ (this one does not have land cover frac)
model_no<-which(gdf$modl=="LPJ")
model_df<-gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)

gdf$data[[model_no]]$npp_init<-gdf$data[[model_no]]$npp_init/31536000*12
gdf$data[[model_no]]$npp_final<-gdf$data[[model_no]]$npp_final/31536000*12
gdf$data[[model_no]]$gpp_init<-gdf$data[[model_no]]$gpp_init/31536000*12 
gdf$data[[model_no]]$gpp_final<-gdf$data[[model_no]]$gpp_final/31536000*12
gdf$data[[model_no]]$rh_init<-gdf$data[[model_no]]$rh_init/31536000*12
gdf$data[[model_no]]$rh_final<-gdf$data[[model_no]]$rh_final/31536000*12

### VISIT(no land cover change map)
model_no<-which(gdf$modl=="VISIT")
model_df<-gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df),na.rm = T)
sum(!model_df$landCoverFrac==0)

### DLEM(no land cover change map)
model_no<-which(gdf$modl=="DLEM")
model_df<-gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df),na.rm = T)
sum(!model_df$landCoverFrac==0)

### IBIS(no land cover change map)
model_no<-which(gdf$modl=="IBIS")
model_df<-gdf$data[[model_no]]
colMeans(as.matrix(model_df),na.rm = T) #strange medium, but mean ok,
#there are lots of values around 6.000000e-04 in northern area for Cwood??
sum(!model_df$landCoverFrac==0)

### LPX-Bern (this one land cover frac change)

model_no<-which(gdf$modl=="LPX-Bern")
model_df<-gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df),na.rm = T)
sum(!model_df$landCoverFrac==0)



### SDGVM(no land cover change map)
model_no<-which(gdf$modl=="SDGVM")
model_df<-gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df),na.rm = T)
sum(!model_df$landCoverFrac==0)



get_deltas <- function(df){
  df %>%
      ## get aboveground biomass as sum of cWood and cLeaf
  mutate(cveg_ag_init = cleaf_init + cwood_init,
         cveg_ag_final = cleaf_final + cwood_final,
         csoil_final=csoil_final + cLitter_final,
         csoil_init=csoil_init + cLitter_init
         ) %>%
    mutate(dcveg = (cveg_final - cveg_init)/cveg_init,
           dcveg_ag = (cveg_ag_final - cveg_ag_init)/cveg_ag_init,
           dnpp = (npp_final - npp_init)/npp_init,
           dcsoil = (csoil_final - csoil_init)/csoil_init,
           dcsoil_star = (csoil_star_final - csoil_star_init)/csoil_star_init,
           dgpp = (gpp_final - gpp_init)/gpp_init,
           dfveg_XX = (fveg_XX - npp_init)/npp_init,
           dcleaf= (cleaf_final - cleaf_init)/cleaf_init,
           dcveg_star = (cveg_star_final - cveg_init)/cveg_init,
           dCroot=(croot_final-croot_init)/croot_init,
           dCwood=(cwood_final-cwood_init)/cwood_init
           )
}

get_csoil_star <- function(df){
  df %>%
    mutate(csoil_star_init  = csoil_init) %>%
    # mutate(csoil_change = csoil_final - csoil_init) %>%   # overwriting what's read from file - XXX This was wrong XXX
    # _change is the Csoil(t+1) - Csoil(t) in final ten years, not the dCsoil = Csoil(t) - Csoil(1)
    mutate(csoil_change = csoil_change / 10.0) %>%
    mutate(csoil_star_final = csoil_final / (1.0 - (csoil_change)/npp_final ))%>%
    mutate(fveg_XX = npp_final-cveg_change/10)%>%
    mutate(csoil_star_final = npp_final* (csoil_final/rh_final))%>% # HY proposed a new equation here for Csoil_star_final
    mutate(cveg_star_final = npp_final* (cveg_final/fveg_XX))
}

Land_cover_no_change <- function(df){
  df %>%
    filter(landCoverFrac==0)
}

gdf <- gdf %>%
  mutate(data = purrr::map(data, ~get_csoil_star(.))) %>%
  mutate(data = purrr::map(data, ~get_deltas(.)))%>%
  mutate(data = purrr::map(data, ~Land_cover_no_change(.)))

#save(gdf,file="gdf_Trendyv11_202406.rda")
#load("gdf_Trendyv9.rda")
summary_table<-as.data.frame(c('ALL','CLASSIC',
'IBIS',
'LPJ',
'ORCHIDEE',
'VISIT',
'ISBA-CTRIP',
'CABLE-POP',
'CLM5.0',
'DLEM',
'ISAM',
'JSBACH',
'JULES',
'LPJ-GUESS',
'LPX-Bern',
'VISIT-NIES',
'SDGVM'
))
colnames(summary_table)<-'modl' 
load("gdf_Trendyv11_202406.rda")

```


Some tests. and correct data if unit is wrong 
```{r}
# make_hist <- function(df){
#   gg <- df %>% 
#     mutate(dnpp = npp_final / npp_init) %>% 
#     filter(dnpp > 0.2 & dnpp < 3) %>% 
#     ggplot(aes(x = dnpp, y = ..density..)) +
#     geom_histogram()
#   return(gg)
# }
# 
# gdf <- gdf %>% 
#   mutate(gg_hist_dnpp = purrr::map(data, ~make_hist(.)))

testdf <- gdf$data[[4]] %>%
  mutate(dnpp = npp_final / npp_init)

gdf$data[[2]]$dgpp %>% quantile(., probs = c(0.1, 0.5, 0.9), na.rm=T)



```

<!-- Weird:  -->
<!-- - CABLE has constant NPP. --> (HY: but it is not from what I can see)

## Plot relationships

### GPP -> NPP

```{r}
source("analyse_modobs2.R")
source("LSD.heatscatter.R")
source("plot_map3.R")
library(tidyverse)
library(ggbreak) 
library(ggplot2)
library(ggpubr)

get_p_value <- function(x, na.rm=TRUE) {
  p.value <- t.test(x, mu = 1)$p.value
  p.value
}


set.seed(1982)

nrow<-gdf %>%
  mutate(n = purrr::map_int(data, ~nrow(.))) 
nrow$n
## histogram pooled
gdf %>%
  mutate(n = purrr::map_int(data, ~nrow(.))) %>%
  mutate(data = purrr::map(data, ~slice_sample(., n = 5174,replace = TRUE))) %>% # smallest set here
  unnest(data) %>%
  dplyr::filter(!is.nan(dgpp), !is.nan(dnpp), !is.infinite(dgpp), !is.infinite(dnpp)) %>%
  mutate(l_npp_gpp = dnpp / dgpp) %>% 
  ggplot() +
  geom_density(aes(x = l_npp_gpp, y = ..density..)) +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1,3) +
  # theme_classic() +
  labs(title = "TRENDY v9", subtitle = "All models pooled", x = expression(italic("L")[NPP:GPP]), y = "Density")
ggsave("hist_dgpp_dnpp_trendy_pooled.pdf", width = 3, height = 2.5)





## all models separately (facet_grid)
gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174,replace=T))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dnpp < 2.5 & dnpp > -1.5 & dgpp < 2.5 & dgpp > -1.5) %>%
  dplyr::filter(!is.nan(dnpp), !is.nan(dgpp), !is.infinite(dnpp), !is.infinite(dgpp)) %>%
  ggplot(aes(x = dgpp, y = dnpp)) +
  geom_hex(bins = 100) +
  theme_classic() +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  xlim(-1, 2) + ylim(-1, 2) +
  labs(x = expression(Delta ~ "GPP/GPP"), y = expression(Delta ~ "NPP/NPP"))+
  theme(legend.position = "none",
        strip.background = element_blank())

ggsave("dgpp_dnpp_trendy_s1_bymodl.jpg", width = 9, height = 13)

## histograms by model

nice_gdf <- gdf %>% # first count the percentage
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dgpp), !is.nan(dnpp), !is.infinite(dgpp), !is.infinite(dnpp)) %>%
  mutate(l_npp_gpp = dnpp / dgpp)%>%
  filter(l_npp_gpp<100000, l_npp_gpp>-1000000) # to remove NA and infinite

Quantile_result<-nice_gdf%>%
  group_by(modl)%>%
  summarise(l_npp_gpp_iqr = quantile(l_npp_gpp,probs=0.75) - quantile(l_npp_gpp,probs=0.25),
            l_npp_gpp_50 = quantile(l_npp_gpp,probs=0.5),
            p_value = get_p_value (l_npp_gpp))
summary_table<-left_join(summary_table,Quantile_result,by='modl')

Labels<-nice_gdf%>%
  mutate(l_npp_gpp_larger_than_one = l_npp_gpp>1)%>%
  group_by(modl)%>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_npp_gpp_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)


nice_gdf %>% 
  ggplot() +
  geom_density(aes(x = l_npp_gpp, y = ..density..)) +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1,3) +
  geom_text(data = Labels,aes(x=-Inf, y = Inf,label=percentage_smaller_than_one),hjust = -2, vjust= 1.5)+
  geom_text(data = Labels,aes(x=Inf, y = Inf,label=percentage_larger_than_one),hjust = 3,vjust= 1.5)+
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  labs(x = expression(italic("L")[NPP:GPP]), y = "Density") 


ggsave("hist_dgpp_dnpp_trendy_bymodl.jpg", width = 9, height = 10.5)
###plot_map3

points_plot<- list() #First prepare a list to store images
havealook<-gdf %>% #Prepare the dataset, this is similar to the histogram above
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      #mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dgpp), !is.nan(dnpp), !is.infinite(dgpp), !is.infinite(dnpp)) %>%
  mutate(l_npp_gpp = dnpp / dgpp)%>%
  filter(l_npp_gpp>-1 & l_npp_gpp<3)%>%
  mutate(lon=ifelse(lon>180,lon-360,lon)) #some maps have longitude from 0 to 360, need to convert to -180 to 180
  
for (i in 1:length(gdf$modl)) {
  points_plot[[i]]<-havealook%>%
  filter(modl==gdf$modl[i])%>%
  plot_map3(., varnam = "l_npp_gpp" ,latmin = -65, latmax = 85,plot_subtitle =gdf$modl[i])
} #Plot a map for each model 

plot<-ggpubr::ggarrange(plotlist=points_plot,
                    ncol = 3, nrow = 6) #Gather them together
FIGURE<-ggpubr::annotate_figure(plot, top = ggpubr::text_grob(expression(italic("L")[NPP:GPP])))
ggsave(plot=FIGURE,filename = "MAP_dgpp_dnpp_trendy_bymodl.pdf",height=12, width = 9)



havealook_spatial_map<-havealook%>%
filter(!modl=='ALL')%>%
  mutate(lon=floor(lon),lat=floor(lat))%>%
    mutate(l_npp_gpp=ifelse(l_npp_gpp>1.5,1.5,l_npp_gpp),
         l_npp_gpp=ifelse(l_npp_gpp<0.6,0.6,l_npp_gpp))%>%
  group_by(lon,lat,modl)%>%
  summarise(l_npp_gpp=median(l_npp_gpp))%>%
  group_by(lon,lat)%>%
   summarise(l_npp_gpp_sd=sd(l_npp_gpp),
             l_npp_gpp=mean(l_npp_gpp))

map1<-havealook_spatial_map%>%
  plot_map3(., varnam = "l_npp_gpp" ,latmin = -65, latmax = 85,plot_subtitle = 'l_npp_gpp')

map2<-havealook_spatial_map%>%
  plot_map3(., varnam = "l_npp_gpp_sd" ,latmin = -65, latmax = 85,plot_subtitle = 'Standard deviation for l_npp_gpp')

ggarrange(map1, map2, ncol = 2, nrow = 1)
ggsave(filename = "Spatial_MAP_l_npp_gpp_trendy.pdf",height=3, width = 9)

```

### NPP -> vegC

```{r}
 set.seed(1982)

## all models separately (facet_grid)
gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174,replace=T))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dcveg_star < 2.5 & dcveg_star > -1.5 & dnpp < 2.5 & dnpp > -1.5) %>%
  dplyr::filter(!is.nan(dcveg_star), !is.nan(dnpp), !is.infinite(dcveg_star), !is.infinite(dnpp)) %>%
  ggplot(aes(x = dnpp, y = dcveg_star)) +
  geom_hex(bins = 100) +
  theme_classic() +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  xlim(-1, 2) + ylim(-1, 2) +
  labs(x = expression(Delta ~ "NPP/NPP"), y = expression(Delta ~ "cVeg/cVeg"))+
  theme(legend.position = "none",
        strip.background = element_blank())

ggsave("dnpp_dvegc_trendy_s1_bymodl.jpg", width = 9, height = 13)



gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dcveg < 2.5 & dcveg > -1.5 & dnpp < 2.5 & dnpp > -1.5) %>%
  dplyr::filter(!is.nan(dcveg), !is.nan(dnpp), !is.infinite(dcveg), !is.infinite(dnpp)) %>%
  ggplot(aes(x = dnpp, y = dcveg)) +
  geom_hex(bins = 100) +
  theme_classic() +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  xlim(-1, 2) + ylim(-1, 2) +
  labs(x = expression(Delta ~ "NPP/NPP"), y = expression(Delta ~ "cVeg/cVeg"))+
  theme(legend.position = "none",
        strip.background = element_blank())

ggsave("dnpp_dvegc_no_star_trendy_s1_bymodl.jpg", width = 9, height = 13)

## histograms by model

nice_gdf <- gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174,replace=T))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dnpp), !is.nan(dcveg_star), !is.infinite(dnpp), !is.infinite(dcveg_star)) %>%
  mutate(l_cveg_star_npp = dcveg_star / dnpp) %>% 
  filter(l_cveg_star_npp<100000, l_cveg_star_npp>-1000000) # to remove NA and infinite

Quantile_result<-nice_gdf%>%
  group_by(modl)%>%
  summarise(l_cveg_star_npp_iqr = quantile(l_cveg_star_npp,probs=0.75) - quantile(l_cveg_star_npp,probs=0.25),
            l_cveg_star_npp_50 = quantile(l_cveg_star_npp,probs=0.5))
summary_table<-left_join(summary_table,Quantile_result,by='modl')
  
Labels<-nice_gdf%>%
  mutate(l_larger_than_one = l_cveg_star_npp>1)%>%
  group_by(modl)%>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)


nice_gdf %>%
  ggplot() +
  geom_density(aes(x = l_cveg_star_npp, y = ..density..)) +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1,3) +
  geom_text(data = Labels,aes(x=-Inf, y = Inf,label=percentage_smaller_than_one),hjust = -2, vjust= 1.5)+
  geom_text(data = Labels,aes(x=Inf, y = Inf,label=percentage_larger_than_one),hjust = 3,vjust= 1.5)+
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  labs(x = expression(italic("L")[cVeg_star:NPP]), y = "Density")

ggsave("hist_dcveg_dnpp_trendy_bymodl.jpg", width = 9, height = 10.5)

nice_gdf %>%
  ggplot() +
  geom_histogram(binwidth=0.1,aes(x=l_cveg_star_npp,y = stat(density)),fill="#404080", color="#e9ecef", alpha=0.6) +
  xlim(-1,3) +
  theme_classic()+ xlab('relative increase of \ntotal biomass (%) / NPP (%)')+ylab('Kernel density estimate')+ 
  geom_vline(xintercept = 1, color = "grey")
ggsave("cVeg_vs_npp__histogram.jpg",width=3.62, height=2.28)


###plot_map3

points_plot<- list()
havealook<-gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dgpp), !is.nan(dnpp), !is.infinite(dgpp), !is.infinite(dnpp)) %>%
  mutate(l_cveg_star_npp = dcveg_star / dnpp)%>%
  filter(l_cveg_star_npp>-1 & l_cveg_star_npp<3)%>%
  mutate(lon=ifelse(lon>180,lon-360,lon)) #some maps have longitude from 0 to 360, need to convert to -180 to 180
  
for (i in 1:length(gdf$modl)) {
  points_plot[[i]]<-havealook%>%
  filter(modl==gdf$modl[i])%>%
  plot_map3(., varnam = "l_cveg_star_npp" ,latmin = -65, latmax = 85,plot_subtitle =gdf$modl[i])
}

plot<-ggpubr::ggarrange(plotlist=points_plot,
                    ncol = 3, nrow = 6)
FIGURE<-ggpubr::annotate_figure(plot, top = ggpubr::text_grob(expression(italic("L")[cVeg:NPP])))
ggsave(plot=FIGURE,filename = "MAP_dcveg_dnpp_trendy_bymodl.pdf",height=12, width = 9)


points_plot<- list()
havealook<-gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dgpp), !is.nan(dnpp), !is.infinite(dgpp), !is.infinite(dnpp)) %>%
  mutate(l_cveg_star_npp = dcveg_star / dnpp)%>%
  filter(l_cveg_star_npp>-1 & l_cveg_star_npp<3)%>%
  mutate(lon=ifelse(lon>180,lon-360,lon)) #some maps have longitude from 0 to 360, need to convert to -180 to 180
  
for (i in 1:length(gdf$modl)) {
  points_plot[[i]]<-havealook%>%
  filter(modl==gdf$modl[i])%>%
  plot_map3(., varnam = "l_cveg_star_npp" ,latmin = -65, latmax = 85,plot_subtitle =gdf$modl[i])
}

plot<-ggpubr::ggarrange(plotlist=points_plot,
                    ncol = 3, nrow = 6)
FIGURE<-ggpubr::annotate_figure(plot, top = ggpubr::text_grob(expression(italic("L")[cVeg:NPP])))
ggsave(plot=FIGURE,filename = "MAP_dcveg_dnpp_trendy_bymodl.pdf",height=12, width = 9)



havealook_spatial_map<-havealook%>%
filter(!modl=='ALL')%>%
  mutate(lon=floor(lon),lat=floor(lat))%>%
    mutate(l_cveg_star_npp=ifelse(l_cveg_star_npp>2,2,l_cveg_star_npp),
         l_cveg_star_npp=ifelse(l_cveg_star_npp<0.2,0.2,l_cveg_star_npp))%>%
  group_by(lon,lat,modl)%>%
  summarise(l_cveg_star_npp=median(l_cveg_star_npp))%>%
  group_by(lon,lat)%>%
   summarise(l_cveg_star_npp_sd=sd(l_cveg_star_npp),
             l_cveg_star_npp=mean(l_cveg_star_npp))

map1<-havealook_spatial_map%>%
  plot_map3(., varnam = "l_cveg_star_npp" ,latmin = -65, latmax = 85,plot_subtitle = 'l_cveg_star_npp')

map2<-havealook_spatial_map%>%
  plot_map3(., varnam = "l_cveg_star_npp_sd" ,latmin = -65, latmax = 85,plot_subtitle = 'Standard deviation for l_cveg_star_npp')

ggarrange(map1, map2, ncol = 2, nrow = 1)
ggsave(filename = "Spatial_MAP_dcveg_dnpp_trendy.pdf",height=3, width = 9)
```


### cVeg -> cRoot

```{r}
set.seed(1982)

## all models separately (facet_grid)
gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dCroot < 2.5 & dCroot > -1.5 & dcveg < 2.5 & dcveg > -1.5) %>%
  dplyr::filter(!is.nan(dCroot), !is.nan(dcveg), !is.infinite(dCroot), !is.infinite(dcveg)) %>%
  ggplot(aes(x = dcveg, y = dCroot)) +
  geom_hex(bins = 100) +
  theme_classic() +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  xlim(-1, 2) + ylim(-1, 2) +
  labs(y = expression(Delta ~ "cRoot/cRoot"), x = expression(Delta ~ "cVeg/cVeg"))
  theme(legend.position = "none",
        strip.background = element_blank())

ggsave("dcveg_dcroot_trendy_s1_bymodl.pdf", width = 9, height = 10)

## histograms by model

nice_gdf <- gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dcveg), !is.nan(dCroot), !is.infinite(dcveg), !is.infinite(dCroot)) %>%
  mutate(l_croot_cveg = dCroot / dcveg) %>% 
  filter(l_croot_cveg<100000, l_croot_cveg>-1000000) # to remove NA and infinite
  
Labels<-nice_gdf%>%
  mutate(l_larger_than_one = l_croot_cveg>1)%>%
  group_by(modl)%>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)

  
nice_gdf %>%
  ggplot() +
  geom_density(aes(x = l_croot_cveg, y = ..density..)) +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1,3) +
    geom_text(data = Labels,aes(x=-Inf, y = Inf,label=percentage_smaller_than_one),hjust = -2, vjust= 1.5)+
  geom_text(data = Labels,aes(x=Inf, y = Inf,label=percentage_larger_than_one),hjust = 3,vjust= 1.5)+
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  labs(x = expression(italic("L")[cRoot:cVeg]), y = "Density")

ggsave("hist_dcveg_dcroot_trendy_bymodl.pdf", width = 9, height = 10.5)




```


### cVeg -> cAgVeg

```{r}
set.seed(1982)

## all models separately (facet_grid)
gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dcveg_ag < 2.5 & dcveg_ag > -1.5 & dcveg < 2.5 & dcveg > -1.5) %>%
  dplyr::filter(!is.nan(dcveg_ag), !is.nan(dcveg), !is.infinite(dcveg_ag), !is.infinite(dcveg)) %>%
  ggplot(aes(x = dcveg, y = dcveg_ag)) +
  geom_hex(bins = 100) +
  theme_classic() +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  xlim(-1, 2.5) + ylim(-1, 2.5) +
  labs(y = expression(Delta ~ "cAgVeg/cAgVeg"), x = expression(Delta ~ "cVeg/cVeg"))+
  theme(legend.position = "none",
        strip.background = element_blank())

ggsave("dcveg_dcveg_ag_trendy_s1_bymodl.jpg", width = 9, height = 13)

## histograms by model


nice_gdf <- gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dcveg), !is.nan(dcveg_ag), !is.infinite(dcveg), !is.infinite(dcveg_ag)) %>%
  mutate(l_cvegag_cveg = dcveg_ag / dcveg) %>% 
  filter(l_cvegag_cveg<100000, l_cvegag_cveg>-1000000) # to remove NA and infinite

Quantile_result<-nice_gdf%>%
  group_by(modl)%>%
  summarise(l_cvegag_cveg_iqr = quantile(l_cvegag_cveg,probs=0.75)-quantile(l_cvegag_cveg,probs=0.25) ,
            l_cvegag_cveg_50 = quantile(l_cvegag_cveg,probs=0.5))
summary_table<-left_join(summary_table,Quantile_result,by='modl')

Labels<-nice_gdf%>%
  mutate(l_larger_than_one = l_cvegag_cveg>1)%>%
  group_by(modl)%>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)

nice_gdf %>%
  ggplot() +
  geom_density(aes(x = l_cvegag_cveg, y = ..density..)) +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1,3)  +
    geom_text(data = Labels,aes(x=-Inf, y = Inf,label=percentage_smaller_than_one),hjust = -2, vjust= 1.5)+
  geom_text(data = Labels,aes(x=Inf, y = Inf,label=percentage_larger_than_one),hjust = 3,vjust= 1.5)+
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  labs(x = expression(italic("L")[cVeg_ag:cVeg]), y = "Density")

ggsave("hist_dcveg_dcveg_ag_trendy_bymodl.jpg", width = 9, height = 10.5)


# Spatial map

havealook<-gdf %>%
  unnest(data) %>%
  dplyr::filter(!is.nan(dcveg), !is.nan(dcveg_ag), !is.infinite(dcveg), !is.infinite(dcveg_ag)) %>%
  mutate(l_cvegag_cveg = dcveg_ag / dcveg) %>% 
  filter(l_cvegag_cveg<100000, l_cvegag_cveg>-1000000)%>% # to remove NA and infinite
  mutate(lon=ifelse(lon>180,lon-360,lon)) #some maps have longitude from 0 to 360, need to convert to -180 to 180


havealook_spatial_map<-havealook%>%
filter(!modl=='ALL')%>%
  mutate(lon=floor(lon),lat=floor(lat))%>%
    mutate(l_cvegag_cveg=ifelse(l_cvegag_cveg>1.5,1.5,l_cvegag_cveg),
         l_cvegag_cveg=ifelse(l_cvegag_cveg<0.6,0.6,l_cvegag_cveg))%>%
  group_by(lon,lat,modl)%>%
  summarise(l_cvegag_cveg=median(l_cvegag_cveg))%>%
  group_by(lon,lat)%>%
   summarise(l_cvegag_cveg_sd=sd(l_cvegag_cveg),
             l_cvegag_cveg=mean(l_cvegag_cveg))

map1<-havealook_spatial_map%>%
  plot_map3(., varnam = "l_cvegag_cveg" ,latmin = -65, latmax = 85,plot_subtitle = 'l_cvegag_cveg')

map2<-havealook_spatial_map%>%
  plot_map3(., varnam = "l_cvegag_cveg_sd" ,latmin = -65, latmax = 85,plot_subtitle = 'Standard deviation for l_cvegag_cveg')

ggarrange(map1, map2, ncol = 2, nrow = 1)
ggsave(filename = "Spatial_MAP_l_cvegag_cveg_trendy.pdf",height=3, width = 9)
```

### NPP -> SOC

```{r}
set.seed(1982)

## all models separately (facet_grid)
gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dcsoil_star < 2.5 & dcsoil_star > -1.5 & dnpp < 2.5 & dnpp > -1.5) %>%
  dplyr::filter(!is.nan(dcsoil_star), !is.nan(dnpp), !is.infinite(dcsoil_star), !is.infinite(dnpp)) %>%
  ggplot(aes(x = dnpp, y = dcsoil_star)) +
  geom_hex(bins = 100) +
  theme_classic() +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  xlim(-1, 2.5) + ylim(-1, 2.5) +
  labs(y = expression(Delta ~ "cSoil/cSoil"), x = expression(Delta ~ "NPP/NPP"))+
  theme(legend.position = "none",
        strip.background = element_blank())

ggsave("dnpp_dcsoil_star_trendy_s1_bymodl.jpg", width = 9, height = 13)

## histograms by model

nice_gdf <- gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dnpp), !is.nan(dcsoil_star), !is.infinite(dnpp), !is.infinite(dcsoil_star)) %>%
  mutate(l_soc_npp = dcsoil_star / dnpp) %>% 
  filter(l_soc_npp<100000, l_soc_npp>-1000000) # to remove NA and infinite
  
Labels<-nice_gdf%>%
  mutate(l_larger_than_one = l_soc_npp>1)%>%
  group_by(modl)%>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)

Quantile_result<-nice_gdf%>%
  group_by(modl)%>%
  summarise(l_soc_npp_iqr = quantile(l_soc_npp,probs=0.75)-quantile(l_soc_npp,probs=0.25),
            l_soc_npp_50 = quantile(l_soc_npp,probs=0.5))
summary_table<-left_join(summary_table,Quantile_result,by='modl')



nice_gdf %>%
  ggplot() +
  geom_density(aes(x = l_soc_npp, y = ..density..)) +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1,3)  +
    geom_text(data = Labels,aes(x=-Inf, y = Inf,label=percentage_smaller_than_one),hjust = -2, vjust= 1.5)+
  geom_text(data = Labels,aes(x=Inf, y = Inf,label=percentage_larger_than_one),hjust = 3,vjust= 1.5)+
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  labs(x = expression(italic("L")[cSoil_star:NPP]), y = "Density")

ggsave("hist_dnpp_dcsoil_star_trendy_bymodl.jpg", width = 9, height = 10.5)
```


```{r}
## one model
modobs <- gdf$data[[2]] %>%
  dplyr::filter(dnpp < 2 & dnpp > -2 & dcsoil_star < 2 & dcsoil_star > -2) %>%
  dplyr::filter(!is.nan(dnpp), !is.nan(dcsoil_star), !is.infinite(dnpp), !is.infinite(dcsoil_star)) %>%
  analyse_modobs2("dnpp", "dcsoil_star", type = "heat", plot_subtitle = FALSE, plot_linmod = FALSE)
modobs$gg +
  xlim(c(-0.5,1)) + ylim(c(-0.5,1)) +
  labs(title = gdf$modl[[2]])

## all models pooled
modobs <- gdf %>%
  unnest(data) %>%
  dplyr::filter(dnpp < 2 & dnpp > -2 & dcsoil_star < 2 & dcsoil_star > -2) %>%
  dplyr::filter(!is.nan(dnpp), !is.nan(dcsoil_star), !is.infinite(dnpp), !is.infinite(dcsoil_star)) %>%
  analyse_modobs2("dnpp", "dcsoil_star", type = "hex", plot_subtitle = FALSE, plot_linmod = FALSE)
modobs$gg +
  xlim(c(-0.1,0.7)) + ylim(c(-0.1,0.7)) +
  labs(title = "All models pooled")

## cSoil* vs. NPP, all models separately (facet_grid)
gdf %>%
  dplyr::filter(modl != "CABLE-POP") %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      dplyr::filter(modl != "CABLE-POP") %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 4420))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dcsoil_star < 2 & dcsoil_star > -2 & dnpp < 2 & dnpp > -2) %>%
  dplyr::filter(!is.nan(dnpp), !is.nan(dcsoil_star), !is.infinite(dnpp), !is.infinite(dcsoil_star)) %>%
  
  group_by(modl, .add = TRUE) %>% group_split()  %>% 
  map(
    ~ggplot(., aes(x = dcsoil_star, y = dnpp)) +
  stat_density_2d(aes(fill = after_stat(nlevel)), geom = "polygon") +
  theme_classic() +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5),
                       guide = "legend") +
  facet_wrap(. ~ modl, nrow = 3,  scales = "free") +
  xlim(-0.1, 0.9) + ylim(-0.1, 0.9) +
  theme(legend.position = "none",
        strip.background = element_blank())
  ) %>% 
  cowplot::plot_grid(plotlist = ., align = 'hv', ncol = 3)

ggsave("csoil_dnpp_trendy_s1_bymodl.pdf", width = 9, height = 10)

 # labs(x = expression(paste(Delta, "NPP", "/NPP")),
  #     y = expression(paste(Delta, "C"[soil], "/C"[soil])))


# Spatial map

havealook<-gdf %>%
  unnest(data) %>%
  dplyr::filter(!is.nan(dnpp), !is.nan(dcsoil_star), !is.infinite(dnpp), !is.infinite(dcsoil_star)) %>%
  mutate(l_soc_npp = dcsoil_star / dnpp) %>% 
  filter(l_soc_npp<100000, l_soc_npp>-1000000)%>% # to remove NA and infinite

  mutate(lon=ifelse(lon>180,lon-360,lon)) #some maps have longitude from 0 to 360, need to convert to -180 to 180


havealook_spatial_map<-havealook%>%
filter(!modl=='ALL')%>%
  mutate(lon=floor(lon),lat=floor(lat))%>%
    mutate(l_soc_npp=ifelse(l_soc_npp>1.5,1.5,l_soc_npp),
         l_soc_npp=ifelse(l_soc_npp<0.3,0.3,l_soc_npp))%>%
  group_by(lon,lat,modl)%>%
  summarise(l_soc_npp=median(l_soc_npp))%>%
  group_by(lon,lat)%>%
   summarise(l_soc_npp_sd=sd(l_soc_npp),
             l_soc_npp=mean(l_soc_npp))

map1<-havealook_spatial_map%>%
  plot_map3(., varnam = "l_soc_npp" ,latmin = -65, latmax = 85,plot_subtitle = 'l_soc_npp')

map2<-havealook_spatial_map%>%
  plot_map3(., varnam = "l_soc_npp_sd" ,latmin = -65, latmax = 85,plot_subtitle = 'Standard deviation for l_soc_npp')

ggarrange(map1, map2, ncol = 2, nrow = 1)
ggsave(filename = "Spatial_MAP_l_soc_npp_trendy.pdf",height=3, width = 9)


```


### Cveg_star -> SOC

```{r}
set.seed(1982)

## all models separately (facet_grid)
gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dcsoil_star < 2.5 & dcsoil_star > -1.5 & dcveg_star < 2.5 & dcveg_star > -1.5) %>%
  dplyr::filter(!is.nan(dcsoil_star), !is.nan(dcveg_star), !is.infinite(dcsoil_star), !is.infinite(dcveg_star)) %>%
  ggplot(aes(x = dcveg_star, y = dcsoil_star)) +
  geom_hex(bins = 100) +
  theme_classic() +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  xlim(-1, 2.5) + ylim(-1, 2.5) +
  labs(y = expression(Delta ~ "cSoil*/cSoil"), x = expression(Delta ~ "Cveg*/Cveg"))+
  theme(legend.position = "none",
        strip.background = element_blank())

ggsave("dcveg_star_dcsoil_star_trendy_s1_bymodl.jpg", width = 9, height = 13)

## histograms by model

nice_gdf <- gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174,replace = T))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dcveg_star), !is.nan(dcsoil_star), !is.infinite(dcveg_star), !is.infinite(dcsoil_star)) %>%
  mutate(l_soc_veg = dcsoil_star / dcveg_star) %>% 
  filter(l_soc_veg<100000, l_soc_veg>-1000000) # to remove NA and infinite

Quantile_result<-nice_gdf%>%
  group_by(modl)%>%
  summarise(l_soc_veg_iqr = quantile(l_soc_veg,probs=0.75) - quantile(l_soc_veg,probs=0.25),
            l_soc_veg_50 = quantile(l_soc_veg,probs=0.5))

summary_table<-left_join(summary_table,Quantile_result,by='modl')

openxlsx::write.xlsx(summary_table,file = 'Quantile_result for linearity.xlsx' )

Labels<-nice_gdf%>%
  mutate(l_larger_than_one = l_soc_veg>1)%>%
  group_by(modl)%>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)


nice_gdf %>%
  ggplot() +
  geom_density(aes(x = l_soc_veg, y = ..density..)) +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1,3)  +
   geom_text(data = Labels,aes(x=-0, y = Inf,label=percentage_smaller_than_one),hjust = 1, vjust= 1.5)+
   geom_text(data = Labels,aes(x=2, y = Inf,label=percentage_larger_than_one),hjust = 0,vjust= 1.5)+
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  labs(x = expression(italic("L")[cSoil_star:cveg_star]), y = "Density")

ggsave("hist_dcveg_star_dcsoil_star_trendy_bymodl.jpg", width = 9, height = 10.5)




# Spatial map

havealook<-gdf %>%
  unnest(data) %>%
  dplyr::filter(!is.nan(dcveg_star), !is.nan(dcsoil_star), !is.infinite(dcveg_star), !is.infinite(dcsoil_star)) %>%
  mutate(l_soc_veg = dcsoil_star / dcveg_star) %>% 
  filter(l_soc_veg<100000, l_soc_veg>-1000000)%>%  # to remove NA and infinite
  mutate(lon=ifelse(lon>180,lon-360,lon)) #some maps have longitude from 0 to 360, need to convert to -180 to 180


havealook_spatial_map<-havealook%>%
filter(!modl=='ALL')%>%
  mutate(lon=floor(lon),lat=floor(lat))%>%
    mutate(l_soc_veg=ifelse(l_soc_veg>1.5,1.5,l_soc_veg),
         l_soc_veg=ifelse(l_soc_veg<0,0,l_soc_veg))%>%
  group_by(lon,lat,modl)%>%
  summarise(l_soc_veg=median(l_soc_veg))%>%
  group_by(lon,lat)%>%
   summarise(l_soc_veg_sd=sd(l_soc_veg),
             l_soc_veg=mean(l_soc_veg))

map1<-havealook_spatial_map%>%
  plot_map3(., varnam = "l_soc_veg" ,latmin = -65, latmax = 85,plot_subtitle = 'l_soc_veg')

map2<-havealook_spatial_map%>%
  plot_map3(., varnam = "l_soc_veg_sd" ,latmin = -65, latmax = 85,plot_subtitle = 'Standard deviation for l_soc_veg')

ggarrange(map1, map2, ncol = 2, nrow = 1)
ggsave(filename = "Spatial_MAP_l_soc_veg_trendy.pdf",height=3, width = 9)

```


### cVeg -> cleaf (NPP to cLeaf figure is almost the same, not produce here)

We should use cveg_star because leaf turnover time is extremly small, 

```{r}
set.seed(1982)

## all models separately (facet_grid)
gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174,replace=T))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dcleaf < 2.5 & dcleaf > -1.5 & dcveg_star < 2.5 & dcveg_star > -1.5) %>%
  dplyr::filter(!is.nan(dcleaf), !is.nan(dcveg_star), !is.infinite(dcleaf), !is.infinite(dcveg_star)) %>%
  ggplot(aes(x = dcveg_star, y = dcleaf)) +
  geom_hex(bins = 100) +
  theme_classic() +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  xlim(-1, 2.5) + ylim(-1, 2.5) +
  labs(y = expression(Delta ~ "cleaf/cleaf"), x = expression(Delta ~ "cVeg/cVeg"))+
  theme(legend.position = "none",
        strip.background = element_blank())

ggsave("dcveg_dcleaf_trendy_s1_bymodl.pdf", width = 9, height = 10)

## histograms by model
gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174,replace=T))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dcveg_star), !is.nan(dcleaf), !is.infinite(dcveg_star), !is.infinite(dcleaf)) %>%
  mutate(l_cvegag_cveg = dcleaf / dcveg_star) %>% 
  ggplot() +
  geom_density(aes(x = l_cvegag_cveg, y = ..density..)) +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1,3) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  labs(x = expression(italic("L")[cleaf:cVeg]), y = "Density")


nice_gdf <- gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174,replace=T))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dcleaf), !is.nan(dcveg_star), !is.infinite(dcleaf), !is.infinite(dcveg_star)) %>%
  mutate(l_cvegag_cveg = dcleaf / dcveg_star) %>% 
  filter(l_cvegag_cveg<100000, l_cvegag_cveg>-1000000) # to remove NA and infinite

Quantile_result<-nice_gdf%>%
  group_by(modl)%>%
  summarise(l_cvegag_cveg_iqr = quantile(l_cvegag_cveg,probs=0.75) - quantile(l_cvegag_cveg,probs=0.25),
            l_cvegag_cveg_50 = quantile(l_cvegag_cveg,probs=0.5))
summary_table<-left_join(summary_table,Quantile_result,by='modl')
  
Labels<-nice_gdf%>%
  mutate(l_larger_than_one = l_cvegag_cveg>1)%>%
  group_by(modl)%>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)


nice_gdf %>%
  ggplot() +
  geom_density(aes(x = l_cvegag_cveg, y = ..density..)) +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1,3) +
  geom_text(data = Labels,aes(x=-Inf, y = Inf,label=percentage_smaller_than_one),hjust = -2, vjust= 1.5)+
  geom_text(data = Labels,aes(x=Inf, y = Inf,label=percentage_larger_than_one),hjust = 3,vjust= 1.5)+
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  labs(y = expression(Delta ~ "cleaf/cleaf"), x = expression(Delta ~ "cVeg/cVeg"))

ggsave("hist_dcveg_dcleaf_trendy_bymodl.pdf", width = 9, height = 10.5)
```
### cVeg -> cwood

```{r}
set.seed(1982)

## all models separately (facet_grid)
gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dCwood < 2.5 & dCwood > -1.5 & dcveg < 2.5 & dcveg > -1.5) %>%
  dplyr::filter(!is.nan(dCwood), !is.nan(dcveg), !is.infinite(dCwood), !is.infinite(dcveg)) %>%
  ggplot(aes(x = dcveg, y = dCwood)) +
  geom_hex(bins = 100) +
  theme_classic() +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  xlim(-1, 2.5) + ylim(-1, 2.5) +
  labs(y = expression(Delta ~ "cwood/cwood"), x = expression(Delta ~ "cVeg/cVeg"))+
  theme(legend.position = "none",
        strip.background = element_blank())

ggsave("dcveg_dCwood_trendy_s1_bymodl.pdf", width = 9, height = 10)

## histograms by model
gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dcveg), !is.nan(dCwood), !is.infinite(dcveg), !is.infinite(dCwood)) %>%
  mutate(l_cvegag_cveg = dCwood / dcveg) %>% 
  ggplot() +
  geom_density(aes(x = l_cvegag_cveg, y = ..density..)) +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1,3) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  labs(x = expression(italic("L")[cleaf:cVeg]), y = "Density")

ggsave("hist_dcveg_dCwood_trendy_bymodl.pdf", width = 9, height = 10.5)



# Spatial map

havealook<-gdf %>%
  unnest(data) %>%
  dplyr::filter(!is.nan(dCwood), !is.nan(dCwood), !is.infinite(dcveg), !is.infinite(dcveg_ag)) %>%
  mutate(l_cwood_cveg = dCwood / dcveg) %>% 
  filter(l_cwood_cveg<100000, l_cwood_cveg>-1000000)%>% # to remove NA and infinite
  mutate(lon=ifelse(lon>180,lon-360,lon)) #some maps have longitude from 0 to 360, need to convert to -180 to 180


havealook_spatial_map<-havealook%>%
filter(!modl=='ALL')%>%
  mutate(lon=floor(lon),lat=floor(lat))%>%
    mutate(l_cwood_cveg=ifelse(l_cwood_cveg>1.5,1.5,l_cwood_cveg),
         l_cwood_cveg=ifelse(l_cwood_cveg<0.6,0.6,l_cwood_cveg))%>%
  group_by(lon,lat,modl)%>%
  summarise(l_cwood_cveg=median(l_cwood_cveg))%>%
  group_by(lon,lat)%>%
   summarise(l_cwood_cveg_sd=sd(l_cwood_cveg),
             l_cwood_cveg=mean(l_cwood_cveg))

map1<-havealook_spatial_map%>%
  plot_map3(., varnam = "l_cwood_cveg" ,latmin = -65, latmax = 85,plot_subtitle = 'l_cwood_cveg')

map2<-havealook_spatial_map%>%
  plot_map3(., varnam = "l_cwood_cveg_sd" ,latmin = -65, latmax = 85,plot_subtitle = 'Standard deviation for l_cwood_cveg')

ggarrange(map1, map2, ncol = 2, nrow = 1)
```


### cVeg -> cRoot


```{r}

set.seed(1982)

## all models separately (facet_grid)
gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dCroot < 2.5 & dCroot > -1.5 & dcveg < 2.5 & dcveg > -1.5) %>%
  dplyr::filter(!is.nan(dCroot), !is.nan(dcveg), !is.infinite(dCroot), !is.infinite(dcveg)) %>%
  ggplot(aes(x = dcveg, y = dCroot)) +
  geom_hex(bins = 100) +
  theme_classic() +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  xlim(-1, 2.5) + ylim(-1, 2.5) +
  labs(y = expression(Delta ~ "cRoot/cRoot"), x = expression(Delta ~ "cVeg/cVeg"))+
  theme(legend.position = "none",
        strip.background = element_blank())



set.seed(1982)

## all models separately (facet_grid)
gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dCroot < 2.5 & dCroot > -1.5 & dcleaf < 2.5 & dcleaf > -1.5) %>%
  dplyr::filter(!is.nan(dCroot), !is.nan(dcleaf), !is.infinite(dCroot), !is.infinite(dcleaf)) %>%
  ggplot(aes(x = dcleaf, y = dCroot)) +
  geom_hex(bins = 100) +
  theme_classic() +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  xlim(-1, 2.5) + ylim(-1, 2.5) +
  labs(y = expression(Delta ~ "cRoot/cRoot"), x = expression(Delta ~ "cLeaf/cLeaf"))+
  theme(legend.position = "none",
        strip.background = element_blank())


set.seed(1982)

## all models separately (facet_grid)
gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dCwood < 2.5 & dCwood > -1.5 & dcleaf < 2.5 & dcleaf > -1.5) %>%
  dplyr::filter(!is.nan(dCwood), !is.nan(dcleaf), !is.infinite(dCwood), !is.infinite(dcleaf)) %>%
  ggplot(aes(x = dcleaf, y = dCwood)) +
  geom_hex(bins = 100) +
  theme_classic() +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  xlim(-1, 2.5) + ylim(-1, 2.5) +
  labs(y = expression(Delta ~ "cWood/cWood"), x = expression(Delta ~ "cLeaf/cLeaf"))+
  theme(legend.position = "none",
        strip.background = element_blank())


## all models separately (facet_grid)
gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = 5174))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dCwood < 2.5 & dCwood > -1.5 & dCroot < 2.5 & dCroot > -1.5) %>%
  dplyr::filter(!is.nan(dCwood), !is.nan(dCroot), !is.infinite(dCwood), !is.infinite(dCroot)) %>%
  ggplot(aes(x = dCroot, y = dCwood)) +
  geom_hex(bins = 100) +
  theme_classic() +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) +
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") +
  xlim(-1, 2.5) + ylim(-1, 2.5) +
  labs(y = expression(Delta ~ "cWood/cWood"), x = expression(Delta ~ "cRoot/cRoot"))+
  theme(legend.position = "none",
        strip.background = element_blank())

```



<!-- ```{r} -->
<!-- ## just one model -->
<!-- source("Processed_data/analyse_modobs2.R") -->
<!-- source("Processed_data/LSD.heatscatter.R") -->

<!-- modobs <- gdf$data[[2]] %>% -->
<!--   dplyr::filter(dCroot < 2 & dCroot > -2 & dcveg < 2 & dcveg > -2) %>% -->
<!--   dplyr::filter(!is.nan(dCroot), !is.nan(dcveg), !is.infinite(dCroot), !is.infinite(dcveg)) %>% -->
<!--   analyse_modobs2("dCroot", "dcveg", type = "heat", plot_subtitle = FALSE, plot_linmod = FALSE) -->
<!-- modobs$gg + -->
<!--   xlim(c(-0.5,1)) + ylim(c(-0.5,1)) + -->
<!--   labs(title = gdf$modl[[2]]) -->

<!-- ## all models pooled -->
<!-- gdf %>% -->
<!--   unnest(data) %>% -->
<!--   dplyr::filter(dCroot < 2.5 & dCroot > -1.5 & dcveg < 2.5 & dcveg > -1.5) %>% -->
<!--   dplyr::filter(!is.nan(dCroot), !is.nan(dcveg), !is.infinite(dCroot), !is.infinite(dcveg)) %>% -->
<!--   ggplot(aes(y = dCroot, x = dcveg)) + -->
<!--   geom_hex(bins = 100) + -->
<!--   theme_classic() + -->
<!--   geom_abline(intercept=0, slope=1, linetype="dotted") + -->
<!--   scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) + -->
<!--   labs(title = "TRENDY v7", subtitle = "All models pooled", x = expression(Delta ~ "GPP/GPP"), y = expression(Delta ~ "NPP/NPP")) -->

<!-- ggsave("dcveg_dCroot_trendy_pooled.pdf", width = 6, height = 5) -->

<!-- ## histogram -->
<!-- gdf %>% -->
<!--   unnest(data) %>% -->
<!--   dplyr::filter(!is.nan(dcveg), !is.nan(dCroot), !is.infinite(dcveg), !is.infinite(dCroot)) %>% -->
<!--   mutate(l_npp_gpp = dCroot / dcveg) %>%  -->
<!--   ggplot() + -->
<!--   geom_density(aes(x = l_npp_gpp, y = ..density..)) + -->
<!--   geom_vline(xintercept = 1, linetype = "dotted") + -->
<!--   xlim(-1,3) + -->
<!--   labs(title = "TRENDY v7", subtitle = "All models pooled", x = expression(italic("L")[Croot:Cveg]), y = "Density") -->
<!-- ggsave("hist_dcveg_dCroot_trendy_pooled.pdf", width = 3, height = 2.5) -->


<!-- ## all models separately (facet_grid) -->
<!-- gdf %>% -->
<!--   dplyr::filter(modl != "CABLE-POP") %>% -->
<!--   unnest(data) %>% -->
<!--   bind_rows( -->
<!--     ., -->
<!--     gdf %>% -->
<!--       dplyr::filter(modl != "CABLE-POP") %>% -->
<!--       mutate(n = purrr::map_int(data, ~nrow(.))) %>% -->
<!--       mutate(data = purrr::map(data, ~slice_sample(., n = 4420))) %>% # smallest set here -->
<!--       unnest(data) %>% -->
<!--       mutate(modl = "ALL") -->
<!--   ) %>% -->
<!--   dplyr::filter(dCroot>-0.9) %>% # remove points where veg collapses -->
<!--   dplyr::filter(dCroot < 2 & dCroot > -2 & dcveg < 2 & dcveg > -2) %>% -->
<!--   dplyr::filter(!is.nan(dCroot), !is.nan(dcveg), !is.infinite(dCroot), !is.infinite(dcveg))%>% -->

<!--   group_by(modl, .add = TRUE) %>% group_split()  %>%  -->
<!--   map( -->
<!--     ~ggplot(., aes(x = dcveg, y = dCroot)) + -->
<!--   stat_density_2d(aes(fill = after_stat(nlevel)), geom = "polygon") + -->
<!--   theme_classic() + -->
<!--   geom_abline(intercept=0, slope=1, linetype="dotted") + -->
<!--   scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), -->
<!--                        guide = "legend") + -->
<!--   facet_wrap(. ~ modl, nrow = 3,  scales = "free") + -->
<!--   xlim(-0.1, 0.9) + ylim(-0.1, 0.9) + -->
<!--   theme(legend.position = "none", -->
<!--         strip.background = element_blank()) -->
<!--   ) %>%  -->
<!--   cowplot::plot_grid(plotlist = ., align = 'hv', ncol = 3) -->

<!-- ggsave("dcveg_dCroot_trendy_s1_bymodl.pdf", width = 9, height = 10) -->
<!-- ``` -->

<!-- ### dCveg vs. d_cleaf -->

<!-- THE idea is that change in Csoil should be related to change in the flux from vegetation to Csoil -->

<!-- However, there are litter pools, we will need to incorporate this in the future, just change Csoil into total pools of litter and soil -->

<!-- at the moment, we do fveg_XX and dcsoil_star -->

<!-- ```{r} -->
<!-- ## just one model -->
<!-- source("Processed_data/analyse_modobs2.R") -->
<!-- source("Processed_data/LSD.heatscatter.R") -->

<!-- modobs <- gdf$data[[3]] %>% -->
<!--   dplyr::filter(dcveg_star < 2 & dcveg_star > -2 & dcleaf < 2 & dcleaf > -2) %>% -->
<!--   dplyr::filter(!is.nan(dcveg_star), !is.nan(dcleaf), !is.infinite(dcveg_star), !is.infinite(dcleaf)) %>% -->
<!--   analyse_modobs2("dcveg_star", "dcleaf", type = "heat", plot_subtitle = FALSE, plot_linmod = FALSE) -->
<!-- modobs$gg + -->
<!--   xlim(c(-0.5,1)) + ylim(c(-0.5,1)) + -->
<!--   labs(title = gdf$modl[[3]]) -->

<!-- ## all models pooled -->
<!-- gdf %>% -->
<!--   unnest(data) %>% -->
<!--   dplyr::filter(dcveg_star < 2.5 & dcveg_star > -1 & dcleaf < 2.5 & dcleaf > -1) %>% -->
<!--   dplyr::filter(!is.nan(dcveg_star), !is.nan(dcleaf), !is.infinite(dcveg_star), !is.infinite(dcleaf)) %>% -->
<!--   ggplot(aes(x = dcveg_star, y = dcleaf)) + -->
<!--   geom_hex(bins = 150) + -->
<!--   theme_classic() + -->
<!--   geom_abline(intercept=0, slope=1, linetype="dotted") + -->
<!--   scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), trans = "log", breaks = c(1, 10, 100, 1000, 10000)) + -->
<!--   labs(title = "TRENDY v7", subtitle = "All models pooled", x = expression(Delta ~ "cVeg/cVeg"), y = expression(Delta ~ "cLeaf/cLeaf")) -->

<!-- ggsave("dcveg_dcleaf_trendy_pooled.pdf", width = 6, height = 5) -->

<!-- ## histogram -->
<!-- gdf %>% -->
<!--   unnest(data) %>% -->
<!--   dplyr::filter(!is.nan(dcveg_star), !is.nan(dcleaf), !is.infinite(dcveg_star), !is.infinite(dcleaf)) %>% -->
<!--   mutate(l_cleaf_cveg = dcleaf / dcveg_star) %>%  -->
<!--   dplyr::filter(l_cleaf_cveg < 10 & l_cleaf_cveg > -3) %>% -->
<!--   ggplot() + -->
<!--   geom_density(aes(x = l_cleaf_cveg, y = ..density..)) + -->
<!--   geom_vline(xintercept = 1, linetype = "dotted") + -->
<!--   labs(title = "TRENDY v7", subtitle = "All models pooled", x = expression(italic("L")[cLeaf:cVeg]), y = "Density") -->
<!-- ggsave("../fig/hist_dcleaf_dcveg_trendy_pooled.pdf", width = 3, height = 2.5) -->


<!-- ## all models separately (facet_grid) -->
<!-- gdf %>% -->
<!--   dplyr::filter(modl != "CABLE-POP") %>% -->
<!--   unnest(data) %>% -->
<!--   bind_rows( -->
<!--     ., -->
<!--     gdf %>% -->
<!--       dplyr::filter(modl != "CABLE-POP") %>% -->
<!--       mutate(n = purrr::map_int(data, ~nrow(.))) %>% -->
<!--       mutate(data = purrr::map(data, ~slice_sample(., n = 4420))) %>% # smallest set here -->
<!--       unnest(data) %>% -->
<!--       mutate(modl = "ALL") -->
<!--   ) %>% -->
<!--   dplyr::filter(dcveg_star>-0.9) %>% # remove points where veg collapses -->
<!--   dplyr::filter(dcveg_star < 2 & dcveg_star > -2 & dcleaf < 2 & dcleaf > -2) %>% -->
<!--   dplyr::filter(!is.nan(dcveg_star), !is.nan(dcleaf), !is.infinite(dcveg_star), !is.infinite(dcleaf)) %>% -->

<!--   group_by(modl, .add = TRUE) %>% group_split()  %>%  -->
<!--   map( -->
<!--     ~ggplot(., aes(x = dcleaf, y = dcveg_star)) + -->
<!--   stat_density_2d(aes(fill = after_stat(nlevel)), geom = "polygon") + -->
<!--   theme_classic() + -->
<!--   geom_abline(intercept=0, slope=1, linetype="dotted") + -->
<!--   scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), -->
<!--                        guide = "legend") + -->
<!--   facet_wrap(. ~ modl, nrow = 3,  scales = "free") + -->
<!--   xlim(-0.1, 0.9) + ylim(-0.1, 0.9) + -->
<!--   theme(legend.position = "none", -->
<!--         strip.background = element_blank()) -->
<!--   ) %>%  -->
<!--   cowplot::plot_grid(plotlist = ., align = 'hv', ncol = 3) -->

<!-- ggsave("d_cleaf_Cveg_trendy_s1_bymodl.pdf", width = 9, height = 10) -->

<!-- ``` -->




<!-- ### dCsoil vs. d_fVeg_XX change -->

<!-- THE idea is that change in Csoil should be related to change in the flux from vegetation to Csoil -->

<!-- However, there are litter pools, we will need to incorporate this in the future, just change Csoil into total pools of litter and soil -->

<!-- at the moment, we do fveg_XX and dcsoil_star -->

<!-- ```{r} -->
<!-- ## just one model -->
<!-- source("Processed_data/analyse_modobs2.R") -->
<!-- source("Processed_data/LSD.heatscatter.R") -->

<!-- modobs <- gdf$data[[5]] %>% -->
<!--   dplyr::filter(dfveg_XX < 2 & dfveg_XX > -2 & dcsoil_star < 2 & dcsoil_star > -2) %>% -->
<!--   dplyr::filter(!is.nan(dfveg_XX), !is.nan(dcsoil_star), !is.infinite(dfveg_XX), !is.infinite(dcsoil_star)) %>% -->
<!--   analyse_modobs2("dfveg_XX", "dcsoil_star", type = "heat", plot_subtitle = FALSE, plot_linmod = FALSE) -->
<!-- modobs$gg + -->
<!--   xlim(c(-0.5,1)) + ylim(c(-0.5,1)) + -->
<!--   labs(title = gdf$modl[[4]]) -->

<!-- ## all models pooled -->
<!-- gdf %>% -->
<!--   unnest(data) %>% -->
<!--   dplyr::filter(dfveg_XX < 2 & dfveg_XX > -2 & dcsoil_star < 2 & dcsoil_star > -2) %>% -->
<!--   dplyr::filter(!is.nan(dfveg_XX), !is.nan(dcsoil_star), !is.infinite(dfveg_XX), !is.infinite(dcsoil_star)) %>% -->
<!--   ggplot(aes(x = dfveg_XX, y = dcsoil_star)) + -->
<!--   stat_density_2d(aes(fill = after_stat(level)), geom = "polygon") + -->
<!--   theme_classic() + -->
<!--   geom_abline(intercept=0, slope=1, linetype="dotted") + -->
<!--   scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5)) -->

<!-- ## all models separately (facet_grid) -->
<!-- gdf %>% -->
<!--   dplyr::filter(modl != "CABLE-POP") %>% -->
<!--   unnest(data) %>% -->
<!--   bind_rows( -->
<!--     ., -->
<!--     gdf %>% -->
<!--       dplyr::filter(modl != "CABLE-POP") %>% -->
<!--       mutate(n = purrr::map_int(data, ~nrow(.))) %>% -->
<!--       mutate(data = purrr::map(data, ~slice_sample(., n = 4420))) %>% # smallest set here -->
<!--       unnest(data) %>% -->
<!--       mutate(modl = "ALL") -->
<!--   ) %>% -->
<!--   dplyr::filter(dfveg_XX>-0.9) %>% # remove points where veg collapses -->
<!--   dplyr::filter(dfveg_XX < 2 & dfveg_XX > -2 & dcsoil_star < 2 & dcsoil_star > -2) %>% -->
<!--   dplyr::filter(!is.nan(dfveg_XX), !is.nan(dcsoil_star), !is.infinite(dfveg_XX), !is.infinite(dcsoil_star))%>% -->

<!--   group_by(modl, .add = TRUE) %>% group_split()  %>%  -->
<!--   map( -->
<!--     ~ggplot(., aes(x = dfveg_XX, y = dcsoil_star)) + -->
<!--   stat_density_2d(aes(fill = after_stat(nlevel)), geom = "polygon") + -->
<!--   theme_classic() + -->
<!--   geom_abline(intercept=0, slope=1, linetype="dotted") + -->
<!--   scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), -->
<!--                        guide = "legend") + -->
<!--   facet_wrap(. ~ modl, nrow = 3,  scales = "free") + -->
<!--   xlim(-0.1, 0.9) + ylim(-0.1, 0.9) + -->
<!--   theme(legend.position = "none", -->
<!--         strip.background = element_blank()) -->
<!--   ) %>%  -->
<!--   cowplot::plot_grid(plotlist = ., align = 'hv', ncol = 3) -->

<!-- ggsave("dcsoil_star_fveg_XX_trendy_s1_bymodl_withlitter.pdf", width = 9, height = 10) -->

<!-- ``` -->




<!-- I check in detail why there are just some yellow dots on Cable, there are actually data, but the desnsity classification (drawing problem) is not good. Everthing is fine if plotted one model one figure.  -->

<!-- I also checked the warning about non-finite rows removed. this is bassically data points outside the map.  -->



<!-- ### SOC vs. biomass change -->

<!-- ```{r} -->
<!-- # # one model -->
<!-- # modobs <- gdf$data[[2]] %>% -->
<!-- #   dplyr::filter(dcveg < 2 & dcveg > -2 & dcsoil_star < 2 & dcsoil_star > -2) %>% -->
<!-- #   dplyr::filter(!is.nan(dcveg), !is.nan(dcsoil_star), !is.infinite(dcveg), !is.infinite(dcsoil_star)) %>% -->
<!-- #   analyse_modobs2("dcveg", "dcsoil_star", type = "heat", plot_subtitle = FALSE, plot_linmod = FALSE) -->
<!-- # modobs$gg + -->
<!-- #   xlim(c(-0.5,1)) + ylim(c(-0.5,1)) + -->
<!-- #   labs(title = gdf$modl[[2]]) -->

<!-- ## cSoil*, all models pooled -->
<!-- gdf %>% -->
<!--   unnest(data) %>% -->
<!--   dplyr::filter(dcsoil_star < 2 & dcsoil_star > -2 & dcveg_star < 2 & dcveg_star > -2) %>% -->
<!--   dplyr::filter(!is.nan(dnpp), !is.nan(dcveg_star), !is.infinite(dnpp), !is.infinite(dcveg_star)) %>% -->

<!--   ggplot(aes(x = dcveg_star, y = dcsoil_star)) + -->

<!--   stat_density_2d(aes(fill = after_stat(nlevel)), geom = "polygon") + -->
<!--   theme_classic() + -->
<!--   geom_abline(intercept=0, slope=1, linetype="dotted") + -->
<!--   scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), -->
<!--                        guide = "legend") + -->
<!--   xlim(-0.1, 1) + ylim(-0.1, 1) + -->
<!--   labs(x = expression(paste(Delta, "C"[veg], "/C"[veg])), -->
<!--        y = expression(paste(Delta, "C"[soil], "/C"[soil]))) -->
<!--   # theme(legend.position = "none", -->
<!--   #       strip.background = element_blank()) -->

<!-- ## cSoil*, all models separately (facet_grid) -->
<!-- gdf %>% -->
<!--   unnest(data) %>% -->
<!--   bind_rows( -->
<!--     ., -->
<!--     gdf %>% -->
<!--       mutate(n = purrr::map_int(data, ~nrow(.))) %>% -->
<!--       mutate(data = purrr::map(data, ~slice_sample(., n = 1956))) %>% # smallest set here -->
<!--       unnest(data) %>% -->
<!--       mutate(modl = "ALL") -->
<!--   ) %>% -->
<!--   dplyr::filter(dcsoil_star < 2 & dcsoil_star > -2 & dcveg_star < 2 & dcveg_star > -2) %>% -->
<!--   dplyr::filter(!is.nan(dnpp), !is.nan(dcveg_star), !is.infinite(dnpp), !is.infinite(dcveg_star)) %>% -->

<!--   group_by(modl, .add = TRUE) %>% group_split()  %>%  -->
<!--   map( -->
<!--     ~ggplot(., aes(x = dcsoil_star, y = dcveg_star)) + -->
<!--   stat_density_2d(aes(fill = after_stat(nlevel)), geom = "polygon") + -->
<!--   theme_classic() + -->
<!--   geom_abline(intercept=0, slope=1, linetype="dotted") + -->
<!--   scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), -->
<!--                        guide = "legend") + -->
<!--   facet_wrap(. ~ modl, nrow = 3,  scales = "free") + -->
<!--   xlim(-0.1, 0.9) + ylim(-0.1, 0.9) + -->
<!--   theme(legend.position = "none", -->
<!--         strip.background = element_blank()) -->
<!--   ) %>%  -->
<!--   cowplot::plot_grid(plotlist = ., align = 'hv', ncol = 3) -->

<!-- ggsave("csoil_cveg_trendy_s1_bymodl.pdf", width = 9, height = 10) -->

<!-- ## cSoil, all models separately (facet_grid) -->
<!-- gdf %>% -->
<!--   unnest(data) %>% -->
<!--   bind_rows( -->
<!--     ., -->
<!--     gdf %>% -->
<!--       mutate(n = purrr::map_int(data, ~nrow(.))) %>% -->
<!--       mutate(data = purrr::map(data, ~slice_sample(., n = 4420))) %>% # smallest set here -->
<!--       unnest(data) %>% -->
<!--       mutate(modl = "ALL") -->
<!--   ) %>% -->
<!--   dplyr::filter(dcsoil < 2 & dcsoil > -2 & dcveg_star < 2 & dcveg_star > -2) %>% -->
<!--   dplyr::filter(!is.nan(dnpp), !is.nan(dcveg_star), !is.infinite(dnpp), !is.infinite(dcveg_star)) %>% -->

<!--   ggplot(aes(x = dcveg_star, y = dcsoil)) + -->
<!--   stat_density_2d(aes(fill = after_stat(nlevel)), geom = "polygon") + -->
<!--   theme_classic() + -->
<!--   geom_abline(intercept=0, slope=1, linetype="dotted") + -->
<!--   scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), -->
<!--                        guide = "legend") + -->
<!--   facet_wrap(. ~ modl, nrow = 3,  scales = "free") + -->
<!--   xlim(-0.1, 0.9) + ylim(-0.1, 0.9) + -->
<!--   theme(legend.position = "none", -->
<!--         strip.background = element_blank()) -->
<!-- ``` -->

<!-- ### SOC vs. aboveground biomass change -->

<!-- ```{r} -->
<!-- ## cSoil*, all models separately (facet_grid) -->
<!-- gdf %>% -->
<!--   unnest(data) %>% -->
<!--   # bind_rows( -->
<!--   #   ., -->
<!--   #   gdf %>% -->
<!--   #     mutate(n = purrr::map_int(data, ~nrow(.))) %>% -->
<!--   #     mutate(data = purrr::map(data, ~slice_sample(., n = 4420))) %>% # smallest set here -->
<!--   #     unnest(data) %>% -->
<!--   #     mutate(modl = "ALL") -->
<!--   # ) %>% -->
<!--   dplyr::filter(dcsoil_star < 2 & dcsoil_star > -2 & dcveg_ag < 2 & dcveg_ag > -2) %>% -->
<!--   dplyr::filter(!is.nan(dcsoil_star), !is.nan(dcveg_ag), !is.infinite(dcsoil_star), !is.infinite(dcveg_ag))%>% -->

<!--   group_by(modl, .add = TRUE) %>% group_split()  %>%  -->
<!--   map( -->
<!--     ~ggplot(., aes(x = dcsoil_star, y = dcveg_ag)) + -->
<!--   stat_density_2d(aes(fill = after_stat(nlevel)), geom = "polygon") + -->
<!--   theme_classic() + -->
<!--   geom_abline(intercept=0, slope=1, linetype="dotted") + -->
<!--   scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), -->
<!--                        guide = "legend") + -->
<!--   facet_wrap(. ~ modl, nrow = 3,  scales = "free") + -->
<!--   xlim(-0.1, 0.9) + ylim(-0.1, 0.9) + -->
<!--   theme(legend.position = "none", -->
<!--         strip.background = element_blank()) -->
<!--   ) %>%  -->
<!--   cowplot::plot_grid(plotlist = ., align = 'hv', ncol = 3) -->

<!-- ggsave("csoil_cveg_ag_trendy_s1_bymodl.pdf", width = 7, height = 10) -->


<!-- ## cSoil*, all models pooled -->
<!-- gdf %>% -->

<!--   ## sample 1957 points from each model (corresponds to the number of gridcell of the model with coarsest res.) -->
<!--   mutate(data = purrr::map(data, ~slice_sample(., n = 1957))) %>% # smallest set here -->
<!--   unnest(data) %>% -->
<!--   mutate(modl = "ALL") %>% -->

<!--   dplyr::filter(dcsoil_star < 2 & dcsoil_star > -2 & dcveg_ag < 2 & dcveg_ag > -2) %>% -->
<!--   dplyr::filter(!is.nan(dnpp), !is.nan(dcveg_ag), !is.infinite(dnpp), !is.infinite(dcveg_ag)) %>% -->

<!--   ggplot(aes(x = dcveg_ag, y = dcsoil_star)) + -->
<!--   stat_density_2d(aes(fill = after_stat(nlevel)), geom = "polygon") + -->
<!--   theme_classic() + -->
<!--   geom_abline(intercept=0, slope=1, linetype="dotted") + -->
<!--   geom_vline(xintercept = 0, color = "grey50", size = 0.2) + -->
<!--   geom_hline(yintercept = 0, color = "grey50", size = 0.2) + -->
<!--   scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), -->
<!--                        guide = "legend") + -->
<!--   # facet_wrap(. ~ modl, nrow = 3,  scales = "free") + -->
<!--   xlim(-0.2, 1.0) + ylim(-0.2, 1.0) + -->
<!--   labs(x = expression(paste(Delta, "C"[ag-veg], "/C"[ag-veg])), -->
<!--        y = expression(paste(Delta, "C"[soil], "/C"[soil]))) + -->
<!--   theme(legend.position = "none", -->
<!--         strip.background = element_blank()) -->

<!-- ggsave("csoil_cveg_ag_trendy_s1_pooled.pdf", width = 4, height = 3) -->

<!-- # ## Cesar's figure -->
<!-- # df_cesar <- read_csv("./data/model_data_mean_long.csv") -->
<!-- # -->
<!-- # obs.mods <- ggplot(df_cesar, aes(make_pct(Cabove), make_pct(Csoil), colour=type)) + -->
<!-- #   geom_smooth(size=.5,data=filter(df_cesar,type=="modeled"), method = "lm", se=FALSE, color="#e41a1c", formula = y ~ x) + -->
<!-- #   stat_smooth(size=.5,data=filter(df_cesar,type=="observed"), method = "lm", se=FALSE, color="#377eb8", formula = y ~ poly(x, 3)) + # orthogonal polynomials, in this case with a 3rd order -->
<!-- #   geom_errorbar(aes(ymin=make_pct(Csoil)-make_pct(SE.soil), ymax=make_pct(Csoil)+make_pct(SE.soil)), width=1,size=.3,colour="black") + -->
<!-- #   geom_point(aes(shape=Site),size=1.5,fill="white",alpha=.7) + -->
<!-- #   scale_shape_manual(values=c(21:25,4)) + guides(colour=guide_legend(title=NULL)) + -->
<!-- #   scale_colour_manual(values=c("#e41a1c","#377eb8")) + -->
<!-- #   guides(col = guide_legend(title = NULL,order = 0), -->
<!-- #          shape = guide_legend(title = "Experiment",order = 1)) + -->
<!-- #   labs(x=expression(paste(CO[2]," effect on biomass carbon (%)", sep="")), -->
<!-- #        y=expression(paste(CO[2]," effect on soil carbon (%)", sep=""))) + -->
<!-- #   theme_cowplot(font_size=8) + -->
<!-- #   theme(legend.position = c(0.7, 0.7), -->
<!-- #         legend.spacing.y = unit(2, "pt")) -->


<!-- ## cSoil, all models separately (facet_grid) -->
<!-- gdf %>% -->
<!--   dplyr::filter(modl != "CABLE-POP") %>% -->
<!--   unnest(data) %>% -->
<!--   bind_rows( -->
<!--     ., -->
<!--     gdf %>% -->
<!--       dplyr::filter(modl != "CABLE-POP") %>% -->
<!--       mutate(n = purrr::map_int(data, ~nrow(.))) %>% -->
<!--       mutate(data = purrr::map(data, ~slice_sample(., n = 4420))) %>% # smallest set here -->
<!--       unnest(data) %>% -->
<!--       mutate(modl = "ALL") -->
<!--   ) %>% -->
<!--   dplyr::filter(dcsoil < 2 & dcsoil > -2 & dcveg_ag < 2 & dcveg_ag > -2) %>% -->
<!--   dplyr::filter(!is.nan(dnpp), !is.nan(dcveg_ag), !is.infinite(dnpp), !is.infinite(dcveg_ag)) %>% -->
<!--   ggplot(aes(x = dcveg_ag, y = dcsoil)) + -->
<!--   stat_density_2d(aes(fill = after_stat(nlevel)), geom = "polygon") + -->
<!--   theme_classic() + -->
<!--   geom_abline(intercept=0, slope=1, linetype="dotted") + -->
<!--   scale_fill_gradientn(colours = colorRampPalette( c("gray65", "navy", "red", "yellow"))(5), -->
<!--                        guide = "legend") + -->
<!--   facet_wrap(. ~ modl, nrow = 3,  scales = "free") + -->
<!--   xlim(-0.1, 0.9) + ylim(-0.1, 0.9) + -->
<!--   theme(legend.position = "none", -->
<!--         strip.background = element_blank()) -->
<!-- ``` -->

Write to file.
```{r}
save(gdf, file = "data/gdf.RData")
```