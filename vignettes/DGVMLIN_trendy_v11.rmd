---
title: "Diagnose Linearity in DGVMs"
author: "huanyuan zhang-zheng"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
# output:
#   pdf_document:
#     toc: true
#     toc_depth: 2
---

```{r}
library(tidyverse)
library(here)
rm(list=ls())
#setwd("~/E/RA/DGVM_density_plot/trendy_v9") #h
#setwd('F:/Oxford/Chapter_four/dgvmlin')
# If you only want to draw figures, only do this: load(here("data/gdf_Trendyv11_202406.rda")) 

```

## Approach

Does (steady-state) SOC storage, simulated in DGVMs, scale with litter inputs? And do litter inputs scale with biomass? To investigate this, we can look at the following relationships:

- The relative enhancement in steady-state SOC vs. the relative enhancement in NPP. $C^\ast$ is the steady-state SOC. It is given by the initial SOC stocks in simulations (spun up to steady state). 
$$
\frac{\Delta C^\ast}{C^\ast} / \frac{\Delta NPP}{NPP_\text{init}}
$$
- The relative enhancement in steady-state SOC vs. the relative enhancement in biomass ($B$).
$$
\frac{\Delta C^\ast}{C^\ast} / \frac{\Delta B}{B_\text{init}}
$$
$\Delta$ is the difference between end and beginning of a transient simulation covering the historical period, where only CO2 changes (hence, soil turnover rates should not change in a typical 1st order kinetics-based SOC model).

Our hypothesis is that these relationships follow the 1:1 line.

$\Delta C^\ast$ cannot be extracted directly from simulations. But it can be estimated from the imbalance between soil respiration and litter input before a steady state is reached:
$$
\tau \approx \frac{C(t)}{\text{NPP}(t) - \Delta C(t)}
$$

Combine this with $\Delta C^\ast=\tau \; \text{NPP}$, to get:
$$
C^\ast = \frac{C(t)}{1 - \frac{\Delta C(t)}{\text{NPP}(t)}}
$$
These variables are extracted from TRENDY S1 simulations as follows:

- $C(t)$: soil C at the end of the simulation (mean over 2008-2017)
- $\Delta C(t)$: Annual change in soil C during the last decade (2008-2017) (`filn_cSoil_change` - MUST BE DIVIDED BY 10!)
- NPP$(t)$: Annual mean NPP during the last decade (2008-2017)

- $\Delta C^\ast$: $C^\ast$ (as defined above) minus soil C during the first decade of the simulation (spun up to steady state)

The same is done with biomass ($B$).


## Process TRENDY v7 files

(Adjust path for `filnams` to select v8 or v7)

From downloaded TRENDY outputs (here, simulation S1: only CO2 is changing), get global fields of: 

1. Multi-annual mean NPP at the beginning of the simulation
2. Multi-annual mean NPP at the end of the simulation
3. Multi-annual mean SOC at the beginning of the simulation
4. Multi-annual mean SOC at the end of the simulation
5. Multi-annual mean biomass at the beginning of the simulation
6. Multi-annual mean biomass at the end of the simulation
7. Change in SOC over a multi-annual period at the end of the simulation (for $\Delta C(t)$)

Simulations should cover 1700-2017 (318 years = time step in NetCDF outputs). But not all do.

- Starting in year 1700: CABLE-POP, CLM5.0, JSBACH, LPX-Bern, LPJ-GUESS, OCN, ORCHIDEE-CNP, SDGVM
- Starting in year 1701: CLASS-CTEM, ISAM, JULES, SURFEX
- Starting in year 1900: DLEM
- Starting in year 1901: ORCHIDEE
- Starting in year 1860: VISIT

Peculiarities of outputs by model prohibiting their processing:

- LPJ: No S1 outputs
- DLEM: failed NPP processing
- LPX-Bern: failed NPP processing
- VISIT: No NPP output available

No separate output for pools (wood, leaf, root)

- CLASS-CTEM
- DLEM
- JSBACH
- JULES
- OCN
- SDGVM (only wood missing, could be derived by `cdo -O sub SDGVM_S1_cVeg.nc SDGVM_S1_cRoot.nc SDGVM_S1_cLeaf.nc`. cWood is then assumed zero: `cdo mulc,0 SDGVM_S1_cLeaf.nc SDGVM_S1_cWood.nc`, and `cdo -O chname,cLeaf,cWood SDGVM_S1_cWood.nc SDGVM_S1_cWood2.nc`, but is not!)
- SURFEX
- VISIT

### Process files: multi-annual mean

Determine for which models we have all the files (cWood and cVeg) to calculate wood mass fractions and create system command.
```{r}

filnams <- read_csv( here("data-raw/filnams_trendy_v11_S1.csv" )) %>% 
  setNames(c("modl", paste0("filn_", names(.)[-1])))

modls <- filnams %>% 
  pull(modl)
# This is a huge list of nc files that we will read
df <- filnams %>% 
  
  ## filter and correct typo
  filter(modl %in% modls) %>%
  mutate(dir = paste0(here(),"")) %>% 
  # Please make sure R here() grab an address pointing to the data folder containing your nc files
  # my here() has "F:/Oxford/Chapter_four/dgvmlin", under this address it has a data folder
  mutate_at(vars(starts_with("filn")), ~str_replace(., "\\.nc", "")) %>%
  mutate_at(vars(starts_with("filn")), ~str_replace(., "cleaf", "cLeaf")) %>%
  mutate_at(vars(starts_with("filn")), ~str_replace(., "croot", "cRoot")) %>%
  mutate_at(vars(starts_with("filn")), ~str_replace(., "csoil", "cSoil")) %>%
  mutate_at(vars(starts_with("filn")), ~str_replace(., "cveg", "cVeg")) %>%
  mutate_at(vars(starts_with("filn")), ~str_replace(., "cwood", "cWood")) %>%
  mutate_at(vars(starts_with("filn")), ~str_replace(., "cRootf", "cRoot")) %>%
  
  ## get starting year
  left_join(read_csv(here("data-raw/startyear_trendy_v11_S1.csv" )), by = "modl") %>% 
  rename(startyear_init = startyear, startyear_npp_init = startyear_npp) %>% 
  mutate(endyear_init = startyear_init + 9, endyear_npp_init = startyear_npp_init + 9) %>% 
  
  rowwise() %>% 
  mutate(filn_cVeg_init  = paste0(filn_cVeg, "_INIT_MEAN"),
         filn_cVeg_final = paste0(filn_cVeg, "_FINAL_MEAN"),

         filn_cLeaf_init  = paste0(filn_cLeaf, "_INIT_MEAN"),
         filn_cLeaf_final = paste0(filn_cLeaf, "_FINAL_MEAN"),

         filn_cRoot_init  = paste0(filn_cRoot, "_INIT_MEAN"),
         filn_cRoot_final = paste0(filn_cRoot, "_FINAL_MEAN"),

         filn_cWood_init  = paste0(filn_cWood, "_INIT_MEAN"),
         filn_cWood_final = paste0(filn_cWood, "_FINAL_MEAN"),
         
         filn_cSoil_init  = paste0(filn_cSoil, "_INIT_MEAN"),
         filn_cSoil_final = paste0(filn_cSoil, "_FINAL_MEAN"),
         
         filn_cSoil_change = paste0(filn_cSoil, "_CHANGE"),
         filn_cVeg_change  = paste0(filn_cVeg, "_CHANGE"),
         filn_cLeaf_change = paste0(filn_cLeaf, "_CHANGE"),
         filn_cWood_change = paste0(filn_cWood, "_CHANGE"),
                  
         filn_npp_init  = paste0(filn_npp, "_INIT_MEAN"),
         filn_npp_final = paste0(filn_npp, "_FINAL_MEAN"),
         
         filn_gpp_init  = paste0(filn_gpp, "_INIT_MEAN"),
         filn_gpp_final = paste0(filn_gpp, "_FINAL_MEAN"),
          
         filn_rh_init  = paste0(filn_rh, "_INIT_MEAN"),
         filn_rh_final = paste0(filn_rh, "_FINAL_MEAN"),
         
         filn_cLitter_init  = paste0(filn_cLitter, "_INIT_MEAN"),
         filn_cLitter_final = paste0(filn_cLitter, "_FINAL_MEAN")
         )
```

## Collect data

... into tidy data frame

source("analyse_modobs2.R")
source("LSD.heatscatter.R")
source("read_nc_onefile.R")
source("nc_to_df.R")
source("df_to_grid.R")

```{r}
source(here("R/collect_gdf_bymodl_HZ_Trendyv11.R"))
source(here("R/nc_to_df.R"))
source(here("R/read_nc_onefile.R"))
here()
getwd()

gdf <- purrr::map(

  as.list(seq(nrow(df))),

  ~collect_gdf_bymodl(

    df$modl[.],
    df$dir[.],

    df$filn_cSoil_init[.],
    df$filn_cSoil_final[.],

    df$filn_cVeg_init[.],
    df$filn_cVeg_final[.],

    df$filn_cLeaf_init[.],
    df$filn_cLeaf_final[.],

    df$filn_cRoot_init[.],
    df$filn_cRoot_final[.],

    df$filn_cWood_init[.],
    df$filn_cWood_final[.],

    df$filn_npp_init[.],
    df$filn_npp_final[.],

    df$filn_cSoil_change[.],
    df$filn_cVeg_change[.],
    
    df$filn_gpp_init[.],
    df$filn_gpp_final[.],
    
    df$filn_rh_init[.],
    df$filn_rh_final[.],
    
    df$filn_cLitter_init[.],
    df$filn_cLitter_final[.],
    
    df$filn_landCoverFrac[.]
    )) %>% 
  
  bind_rows() %>%



  group_by(modl) %>%
  nest()
```


## Calculate relationships

```{r}


#           unit correction  and check data quality ~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# This part is very useful for debug, if you see 0, it means the nc files from Matlab code contain nothing - we did this deliberately to mask variables out of interest. Or variables missing in TRENDY

# You can also use this file to check whether land cover fraction change, 0 in land cover fraction means PFT fraction does not change during the simulation

### JSBACH (no land cover change map)
model_no <- which(gdf$modl=="JSBACH")
model_df <- gdf$data[[model_no]]
#View(model_df)
robustbase::colMedians(as.matrix(model_df),na.rm = T)
sum(!model_df$landCoverFrac==0)

### CABLE-POP(no land cover change map)
model_no <- which(gdf$modl=="CABLE-POP")
model_df <- gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0) # many NA in this file, anyway no land cover change, we use replace them with 0
gdf$data[[model_no]]$landCoverFrac <- 0

### CLASSIC(no land cover change map)
model_no <- which(gdf$modl=="CLASSIC")
model_df <- gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df),na.rm=T)
sum(!model_df$landCoverFrac==0,na.rm=T)

### CLM5.0 (no land cover change map)
model_no <- which(gdf$modl=="CLM5.0")
model_df <- gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)



### ISAM (no land cover change map)
model_no <- which(gdf$modl=="ISAM")
model_df <- gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)
### LPJ-GUESS (this one land cover frac change)
model_no <- which(gdf$modl=="LPJ-GUESS")
model_df <- gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)

### ORCHIDEE(no land cover change map)
model_no <- which(gdf$modl=="ORCHIDEE")
model_df <- gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)

### CLASSIC(no land cover change map)
model_no <- which(gdf$modl=="ORCHIDEE")
model_df <- gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df),na.rm = T)
sum(!model_df$landCoverFrac==0)

### JULES (this one land cover frac change)
model_no <- which(gdf$modl=="JULES")
model_df <- gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)

### LPJ (this one does not have land cover frac)
model_no <- which(gdf$modl=="LPJ")
model_df <- gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df))
sum(!model_df$landCoverFrac==0)


### VISIT(no land cover change map)
model_no <- which(gdf$modl=="VISIT")
model_df <- gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df),na.rm = T)
sum(!model_df$landCoverFrac==0)

### DLEM(no land cover change map)
model_no <- which(gdf$modl=="DLEM")
model_df <- gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df),na.rm = T)
sum(!model_df$landCoverFrac==0)

### IBIS(no land cover change map)
model_no <- which(gdf$modl=="IBIS")
model_df <- gdf$data[[model_no]]
colMeans(as.matrix(model_df),na.rm = T) #strange medium, but mean ok,
#there are lots of values around 6.000000e-04 in northern area for Cwood??
sum(!model_df$landCoverFrac==0)

### LPX-Bern (this one land cover frac change)

model_no <- which(gdf$modl=="LPX-Bern")
model_df <- gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df),na.rm = T)
sum(!model_df$landCoverFrac==0)



### SDGVM(no land cover change map)
model_no <- which(gdf$modl=="SDGVM")
model_df <- gdf$data[[model_no]]
robustbase::colMedians(as.matrix(model_df),na.rm = T)
sum(!model_df$landCoverFrac==0)

get_csoil_star <- function(df){
  df %>%
    mutate(csoil_star_init  = csoil_init) %>%
    # mutate(csoil_change = csoil_final - csoil_init) %>%   # overwriting what's read from file - XXX This was wrong XXX
    # _change is the Csoil(t+1) - Csoil(t) in final ten years, not the dCsoil = Csoil(t) - Csoil(1)
    mutate(csoil_change = csoil_change / 10.0) %>%
    mutate(csoil_star_final = csoil_final / (1.0 - (csoil_change)/npp_final )) %>%
    mutate(fveg_XX = npp_final-cveg_change/10) %>%
    mutate(csoil_star_final = npp_final* (csoil_final/rh_final)) %>% # HY proposed a new equation here for Csoil_star_final
    mutate(cveg_star_final = npp_final* (cveg_final/fveg_XX))
}

get_deltas <- function(df){
  df %>%
      ## get aboveground biomass as sum of cWood and cLeaf
  mutate(cveg_ag_init = cleaf_init + cwood_init,
         cveg_ag_final = cleaf_final + cwood_final,
         csoil_final=csoil_final + cLitter_final,
         csoil_init=csoil_init + cLitter_init
         ) %>%
    mutate(dcveg = (cveg_final - cveg_init)/cveg_init,
           dcveg_ag = (cveg_ag_final - cveg_ag_init)/cveg_ag_init,
           dnpp = (npp_final - npp_init)/npp_init,
           dcsoil = (csoil_final - csoil_init)/csoil_init,
           dcsoil_star = (csoil_star_final - csoil_star_init)/csoil_star_init,
           dgpp = (gpp_final - gpp_init)/gpp_init,
           dfveg_XX = (fveg_XX - npp_init)/npp_init,
           dcleaf= (cleaf_final - cleaf_init)/cleaf_init,
           dcveg_star = (cveg_star_final - cveg_init)/cveg_init,
           dCroot=(croot_final-croot_init)/croot_init,
           dCwood=(cwood_final-cwood_init)/cwood_init
           ) %>%
    mutate(l_npp_gpp = dnpp / dgpp,
           l_croot_cveg = dCroot / dcveg,
           l_cveg_star_npp = dcveg_star / dnpp)
}



Land_cover_no_change <- function(df){
  df %>%
    filter(landCoverFrac==0)
}

gdf <- gdf %>%
  mutate(data = purrr::map(data, ~get_csoil_star(.))) %>%
  mutate(data = purrr::map(data, ~get_deltas(.))) %>%
  mutate(data = purrr::map(data, ~Land_cover_no_change(.)))

#save(gdf,file=here("data/gdf_Trendyv11_202407.rda"))

summary_table <- as.data.frame(c('ALL',"C only models" ,"CN coupled models",'CLASSIC',
'IBIS',
'LPJ',
'ORCHIDEE',
'VISIT',
'ISBA-CTRIP',
'CABLE-POP',
'CLM5.0',
'DLEM',
'ISAM',
'JSBACH',
'JULES',
'LPJ-GUESS',
'LPX-Bern',
'VISIT-NIES',
'SDGVM'
))
colnames(summary_table) <- c('modl')
summary_table$CN_coupled<-c(NA,NA,NA,'No',
'No',
'No',
'Yes',
'No',
'No',
'Yes',
'Yes',
'Yes',
'Yes',
'Yes',
'Yes',
'Yes',
'Yes',
'No',
'Yes')
load(here("data/gdf_Trendyv11_202407.rda"))

```


Run Some tests. and correct data if unit is wrong 



```{r}

testdf <- gdf$data[[4]] %>%
  mutate(dnpp = npp_final / npp_init)

# This should be raning from 0 to 50%
gdf$data[[1]]$dgpp %>% quantile(., probs = c(0.1, 0.5, 0.9), na.rm=T)

```

<!-- Weird:  -->
<!-- - CABLE has constant NPP. --> (HY: but it is not from what I can see)

# Plot relationships

```{r}

get_p_value <- function(x, na.rm=TRUE) {
  p.value <- t.test(x, mu = 1)$p.value
  p.value
}
# sample for even representation, number determined by model with smallest 
# number of gridcells
nsample <- gdf %>% 
  mutate(len = purrr::map_int(data, ~nrow(.))) %>% 
  pull(len) %>% 
  min()


coast <- rnaturalearth::ne_coastline(
  scale = 110, 
  returnclass = "sf"
  )


```


### Cveg vs NPP 

#### All models pooled


```{r}

# all models pooled
gg1 <- gdf %>%
  mutate(data = purrr::map(data, ~slice_sample(., n = nsample))) %>%
  unnest(data) %>%
  dplyr::filter(!is.nan(dnpp), !is.nan(dcveg_star), !is.infinite(dnpp), !is.infinite(dcveg_star)) %>%
  ggplot(aes(x = dnpp, y = dcveg_star)) +
  geom_hex(bins = 50, show.legend = FALSE) +
  theme_classic() +
  geom_abline(intercept = 0, slope = 1, linetype = "dotted") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  khroma::scale_fill_batlowW(trans = "log", reverse = TRUE) +
  xlim(-1, 2) + 
  ylim(-1, 2) +
  labs(
    x = expression(paste(Delta, "NPP/NPP")),
    y = expression(paste(Delta, italic(C)[veg^"*"], "/", italic(C)[veg]))
  )


supernice_gdf<-gdf %>%
  mutate(data = purrr::map(data, ~slice_sample(., n = nsample))) %>%
  unnest(data)%>%
  dplyr::filter(!is.nan(dnpp), !is.nan(dcveg_star), !is.infinite(dnpp), !is.infinite(dcveg_star)) %>% 
  filter(l_cveg_star_npp<100000, l_cveg_star_npp>-1000000) 



# Lables for Histogram  
Labels <- supernice_gdf%>%
  ungroup()%>%
  mutate(l_larger_than_one = l_cveg_star_npp>1) %>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)

gg2 <- supernice_gdf %>% 
  ggplot(aes(x = l_cveg_star_npp, y = ..density..)) +
  geom_density(fill = "grey70") +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1, 2.5) + 
    geom_text(data = Labels,aes(x=-Inf, y = Inf,label=percentage_smaller_than_one),hjust = -2, vjust= 1.5)+
  geom_text(data = Labels,aes(x=Inf, y = Inf,label=percentage_larger_than_one),hjust = 3,vjust= 1.5)+
  labs(
    x = expression(paste(italic(L)[Cveg^"*"/NPP]))
  )

cowplot::plot_grid(
  gg1, 
  gg2,
  ncol = 2,labels =c('(a)','(b)')
)

ggsave(here("fig/cveg_star_npp_trendy_pooled.pdf"), width = 8, height = 4)


```


#### By models

```{r}
nice_gdf <- gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = nsample,replace=T))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dnpp), !is.nan(dcveg_star), !is.infinite(dnpp), !is.infinite(dcveg_star)) %>% 
  filter(l_cveg_star_npp<100000, l_cveg_star_npp>-1000000)

nice_gdf %>%
  ggplot(aes(x = dnpp, y = dcveg_star)) +
  geom_hex(bins = 50, show.legend = FALSE) +
  theme_classic() +
  geom_abline(intercept = 0, slope = 1, linetype = "dotted") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  khroma::scale_fill_batlowW(trans = "log", reverse = TRUE) +
  xlim(-1, 2) + 
  ylim(-1, 2) +
  labs(
    x = expression(paste(Delta, "NPP/NPP")),
    y = expression(paste(Delta, italic(C)[veg^"*"], "/", italic(C)[veg]))
  ) +
  facet_wrap(. ~ modl,  ncol = 3,  scales = "free") +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(size = 12, hjust = 0)
    )

ggsave(here("fig/dnpp_dvegc_trendy_s1_bymodl.pdf"), width = 9, height = 13)


# we need to get some stat for the overall excel table
Quantile_result <- nice_gdf%>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = nsample,replace=T))) %>% # smallest set here
      unnest(data) %>%
      filter(modl %in% c('CLASSIC','IBIS','LPJ', "VISIT" ,  "VISIT-NIES", "ISBA-CTRIP"))%>%
      mutate(modl = "C only models")
  ) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = nsample,replace=T))) %>% # smallest set here
      unnest(data) %>%
      filter(!modl %in% c('CLASSIC','IBIS','LPJ', "VISIT" ,  "VISIT-NIES", "ISBA-CTRIP"))%>%
      mutate(modl = "CN coupled models")
  ) %>%
  dplyr::filter(!is.nan(dnpp), !is.nan(dcveg_star), !is.infinite(dnpp), !is.infinite(dcveg_star)) %>% 
  filter(l_cveg_star_npp<100000, l_cveg_star_npp>-1000000)%>%
  group_by(modl) %>%
  summarise(l_cveg_star_npp_50 = quantile(l_cveg_star_npp,probs=0.5),
            l_cveg_star_npp_25 = quantile(l_cveg_star_npp,probs=0.25),
            l_cveg_star_npp_75 = quantile(l_cveg_star_npp,probs=0.75)) 

summary_table <- left_join(summary_table,Quantile_result,by='modl')

# Lables for Histogram  
Labels <- nice_gdf%>%
  mutate(l_larger_than_one = l_cveg_star_npp>1) %>%
  group_by(modl) %>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)


nice_gdf %>%
ggplot() +
  geom_density(aes(x = l_cveg_star_npp, y = ..density..),fill = "grey70") +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1, 2.5) +
  geom_text(data = Labels,aes(x=-Inf, y = Inf,label=percentage_smaller_than_one),hjust = -2, vjust= 1.5)+
  geom_text(data = Labels,aes(x=Inf, y = Inf,label=percentage_larger_than_one),hjust = 3,vjust= 1.5)+
  labs(
    x = expression(paste(italic(L)[Cveg^"*"/NPP]))
  )+
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") 

ggsave(here("fig/hist_dcveg_dnpp_trendy_bymodl.pdf"), width = 9, height = 10.5)


```

#### Spatial map

```{r}
havealook <- gdf %>%
  unnest(data) %>%
  filter(l_cveg_star_npp>-1 & l_cveg_star_npp<3) %>%
  mutate(lon=ifelse(lon > 180, lon - 360, lon)) #some maps have longitude from 0 to 360, need to convert to -180 to 180

havealook_spatial_map <- havealook
  #  mutate(lon=floor(lon),lat=floor(lat)) %>%
  # mutate(l_cveg_star_npp = ifelse(l_cveg_star_npp>2,2,l_cveg_star_npp),
  #         l_cveg_star_npp = ifelse(l_cveg_star_npp<0.2,0.2,l_cveg_star_npp)) %>%
  #  group_by(lon, lat, modl) %>%
  #  summarise(l_cveg_star_npp = median(l_cveg_star_npp))

# Doing the floor and group_by and have a smoother map for global pattern, but could destroy the by model map, because some models have so coarse resolution that theydo not have a value for each 1 degree pixel

# By model
bymodel_map <- ggplot() +
  geom_raster(
    data = havealook_spatial_map,
    aes(x = lon, y = lat, fill = l_cveg_star_npp),
    show.legend = TRUE
    ) +
  geom_sf(
    data = coast,
    colour = 'black',
    linewidth = 0.3
  )  +
  coord_sf(
    ylim = c(-60, 85),
    expand = FALSE
  ) +
  khroma::scale_fill_vik(
    reverse = TRUE,
    name = "",
    limits = c(0.2,1.8),  
    midpoint = 1
    )+
  theme_void() +
  labs(
    title = expression(paste(italic(L)[Cveg^"*"/NPP])) 
  ) +
  facet_wrap(. ~ modl, ncol = 3)

#  test of individual model, LPJ-GUESS seems to have a problem, not sure why (Huan: now I think it should be the land cover change filter)
model_test<- havealook_spatial_map |> 
  filter(modl == "LPJ-GUESS")%>%
  dplyr::select(lon,l_npp_gpp,lat)
ggplot() +
  geom_raster(data=model_test,
    aes(x = lon, y = lat, fill = l_npp_gpp),
    show.legend = TRUE
    ) +
  geom_sf(
    data = coast,
    colour = 'black',
    linewidth = 0.3
  )  +
  coord_sf(
    ylim = c(-60, 85),
    expand = FALSE
  ) +
  khroma::scale_fill_vik(
    reverse = TRUE,
    name = "",
    limits = c(0.2,1.8),  
    midpoint = 1
    ) +
  theme_void() +
  labs(
    title = expression(paste(italic(L)[Cveg^"*"/NPP])) 
  )
ggsave(bymodel_map,filename = here("fig/Spatial_MAP_dcveg_dnpp_trendyv11_bymodel.pdf"),height=10, width = 10)

# All pooled

havealook_spatial_map <- havealook%>%
    mutate(lon=floor(lon/2)*2,lat=floor(lat/2)*2) %>%
   mutate(l_cveg_star_npp = ifelse(l_cveg_star_npp>2,2,l_cveg_star_npp),
           l_cveg_star_npp = ifelse(l_cveg_star_npp<0.2,0.2,l_cveg_star_npp)) %>%
    group_by(lon, lat, modl) %>%
    summarise(l_cveg_star_npp = median(l_cveg_star_npp))|> 
      group_by(lon, lat) %>%
      summarise(l_cveg_star_npp_sd = sd(l_cveg_star_npp),
                 l_cveg_star_npp = mean(l_cveg_star_npp))

mean_map <- ggplot() +
  geom_raster(
    data = havealook_spatial_map ,
    aes(x = lon, y = lat, fill = l_cveg_star_npp),
    show.legend = TRUE
    ) +
  geom_sf(
    data = coast,
    colour = 'black',
    linewidth = 0.3
  )  +
  coord_sf(
    ylim = c(-60, 85),
    expand = FALSE
  ) +
  khroma::scale_fill_vik(
    reverse = TRUE,
    name = "",
    limits = c(0.2,1.8),  
    midpoint = 1
    ) +
  theme_void() +
  labs(
    title = expression(paste(bold('(c)  '),italic(L)[Cveg^"*"/NPP],'  as Mean across models')) 
  )

sd_map <- ggplot() +
  geom_raster(
    data = havealook_spatial_map,
    aes(x = lon, y = lat, fill = l_cveg_star_npp_sd),
    show.legend = TRUE
    ) +
  geom_sf(
    data = coast,
    colour = 'black',
    linewidth = 0.3
  )  +
  coord_sf(
    ylim = c(-60, 85),
    expand = FALSE
  ) +
  khroma::scale_fill_YlOrBr(
    name = "",
    limits = c(0,0.8), 
    midpoint = 0.4
    ) +
  theme_void() +
  labs(
    title = expression(paste(bold('(d)  '),italic(L)[Cveg^"*"/NPP],'  as SD across models')) 
  )

cowplot::plot_grid(
  mean_map, 
  sd_map,
  nrow = 2
)

ggsave(filename = here("fig/Spatial_MAP_dcveg_dnpp_trendyv11.pdf"),height=4, width = 9)

list_of_modl<-unique(havealook$modl)
bymodel_map<-list()
for (i in 1:length(list_of_modl)) {
  havealook_spatial_map<-havealook%>%
filter(modl==list_of_modl[i])%>%
  mutate(l_cveg_star_npp=ifelse(l_cveg_star_npp>2,2,l_cveg_star_npp),
         l_cveg_star_npp=ifelse(l_cveg_star_npp<0.2,0.2,l_cveg_star_npp))
  mean_map<-ggplot() +
	  geom_raster(
	    data = havealook_spatial_map,
	    aes(x = lon, y = lat, fill = l_cveg_star_npp),
	    show.legend = TRUE
	    ) +
    geom_sf(
      data = coast,
      colour = 'black',
      linewidth = 0.3
    )  +
    coord_sf(
      ylim = c(-60, 85),
      expand = FALSE
    ) +
    khroma::scale_fill_vik(
      name = "",
      limits = c(0,2), 
      midpoint = 1
      ) +
    theme_void() +
    labs(
      title = expression(paste(italic(L)[Cveg^"*"/NPP],'  as Mean across models')) 
    )
  bymodel_map[[i]]<-mean_map
}



cowplot::plot_grid(
 plotlist=  bymodel_map,
  nrow = 6 ,ncol = 3
)

```

### GPP vs NPP 

#### All models pooled


```{r}

# all models pooled
gg1 <- gdf %>%
  mutate(data = purrr::map(data, ~slice_sample(., n = nsample))) %>%
  unnest(data) %>%
  dplyr::filter(!is.nan(dnpp), !is.nan(dgpp), !is.infinite(dnpp), !is.infinite(dgpp)) %>%
  ggplot(aes(x = dgpp, y = dnpp)) +
  geom_hex(bins = 50, show.legend = FALSE) +
  theme_classic() +
  geom_abline(intercept = 0, slope = 1, linetype = "dotted") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  khroma::scale_fill_batlowW(trans = "log", reverse = TRUE) +
  xlim(-1, 2) + 
  ylim(-1, 2) +
  labs(
    x = expression(paste(Delta, "GPP/GPP")),
    y = expression(paste(Delta, "NPP/NPP"))
  )



supernice_gdf<-gdf %>%
  mutate(data = purrr::map(data, ~slice_sample(., n = nsample))) %>%
  unnest(data)%>%
   dplyr::filter(!is.nan(dnpp), !is.nan(dgpp), !is.infinite(dnpp), !is.infinite(dgpp)) %>%
  filter(l_npp_gpp<100000, l_npp_gpp>-1000000) 



# Lables for Histogram  
Labels <- supernice_gdf%>%
  ungroup()%>%
  mutate(l_larger_than_one = l_npp_gpp>1) %>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)



gg2 <- supernice_gdf %>% 
  ggplot(aes(x = l_npp_gpp, y = ..density..)) +
  geom_density(fill = "grey70") +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1, 2.5) + 
      geom_text(data = Labels,aes(x=-Inf, y = Inf,label=percentage_smaller_than_one),hjust = -2, vjust= 1.5)+
  geom_text(data = Labels,aes(x=Inf, y = Inf,label=percentage_larger_than_one),hjust = 3,vjust= 1.5)+
  labs(
    x = expression(paste(italic(L)[NPP/GPP]))
  )

cowplot::plot_grid(
  gg1, 
  gg2,
  ncol = 2,labels =c('(a)','(b)')
)

ggsave(here("fig/dgpp_dnpp_trendy_s1_pooled.pdf"), width = 8, height = 4)

```

#### By model

```{r}
nice_gdf  <- gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = nsample,replace=T))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(dnpp < 2.5 & dnpp > -1.5 & dgpp < 2.5 & dgpp > -1.5) %>%
  dplyr::filter(!is.nan(dnpp), !is.nan(dgpp), !is.infinite(dnpp), !is.infinite(dgpp)) %>% 
  filter(l_npp_gpp<100000, l_npp_gpp>-1000000)

nice_gdf %>%
  ggplot(aes(x = dgpp, y = dnpp)) +
  geom_hex(bins = 50, show.legend = FALSE) +
  theme_classic() +
  geom_abline(intercept = 0, slope = 1, linetype = "dotted") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  khroma::scale_fill_batlowW(trans = "log", reverse = TRUE) +
  xlim(-1, 2) + 
  ylim(-1, 2) +
  labs(
    x = expression(paste(Delta, "GPP/GPP")),
    y = expression(paste(Delta, "NPP/NPP"))
  ) +
  facet_wrap(. ~ modl,  ncol = 3,  scales = "free") +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(size = 12, hjust = 0)
    )

ggsave(here("fig/dnpp_dgpp_trendy_s1_bymodl.pdf"), width = 9, height = 13)


# we need to get some stat for the overall excel table
Quantile_result <- nice_gdf%>%
    bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = nsample,replace=T))) %>% # smallest set here
      unnest(data) %>%
      filter(modl %in% c('CLASSIC','IBIS','LPJ', "VISIT" ,  "VISIT-NIES", "ISBA-CTRIP"))%>%
      mutate(modl = "C only models")
  ) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = nsample,replace=T))) %>% # smallest set here
      unnest(data) %>%
      filter(!modl %in% c('CLASSIC','IBIS','LPJ', "VISIT" ,  "VISIT-NIES", "ISBA-CTRIP"))%>%
      mutate(modl = "CN coupled models")
  ) %>%
   dplyr::filter(dnpp < 2.5 & dnpp > -1.5 & dgpp < 2.5 & dgpp > -1.5) %>%
  dplyr::filter(!is.nan(dnpp), !is.nan(dgpp), !is.infinite(dnpp), !is.infinite(dgpp)) %>% 
  filter(l_npp_gpp<100000, l_npp_gpp>-1000000)%>%
  group_by(modl) %>%
  summarise(l_npp_gpp_50 = quantile(l_npp_gpp,probs=0.5),
            l_npp_gpp_25 = quantile(l_npp_gpp,probs=0.25),
            l_npp_gpp_75 = quantile(l_npp_gpp,probs=0.75),
            R_gpp_50 = quantile(dgpp,probs=0.5),
            R_gpp_25 = quantile(dgpp,probs=0.25),
            R_gpp_75 = quantile(dgpp,probs=0.75)) 

summary_table <- left_join(summary_table,Quantile_result,by='modl')

# Lables for Histogram  
Labels <- nice_gdf%>%
  mutate(l_larger_than_one = l_npp_gpp>1) %>%
  group_by(modl) %>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)


nice_gdf %>%
ggplot() +
  geom_density(aes(x = l_npp_gpp, y = ..density..),fill = "grey70") +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1, 2.5) +
  geom_text(data = Labels,aes(x=-Inf, y = Inf,label=percentage_smaller_than_one),hjust = -2, vjust= 1.5)+
  geom_text(data = Labels,aes(x=Inf, y = Inf,label=percentage_larger_than_one),hjust = 3,vjust= 1.5)+
  labs(
       x = expression(paste(italic(L)[NPP/GPP]))
  )+
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") 

ggsave(here("fig/hist_dnpp_dgpp_trendy_bymodl.pdf"), width = 9, height = 10.5)

```


#### Spatial maps

```{r}

havealook <- gdf %>% #Prepare the dataset, this is similar to the histogram above
  unnest(data) %>%
  dplyr::filter(!is.nan(dgpp), !is.nan(dnpp), !is.infinite(dgpp), !is.infinite(dnpp)) %>%
  mutate(l_npp_gpp = dnpp / dgpp) %>%
  filter(l_npp_gpp>-1 & l_npp_gpp<3) %>%
  mutate(lon=ifelse(lon>180,lon-360,lon)) #some maps have longitude from 0 to 360, need to convert to -180 to 180


havealook_spatial_map <- havealook%>%
filter(!modl=='ALL') %>%
  mutate(lon=floor(lon/2)*2,lat=floor(lat/2)*2) %>%
    mutate(l_npp_gpp=ifelse(l_npp_gpp>1.5,1.5,l_npp_gpp),
         l_npp_gpp=ifelse(l_npp_gpp<0.6,0.6,l_npp_gpp)) %>%
  group_by(lon,lat,modl) %>%
  summarise(l_npp_gpp=median(l_npp_gpp)) %>%
  group_by(lon,lat) %>%
   summarise(l_npp_gpp_sd=sd(l_npp_gpp),
             l_npp_gpp=mean(l_npp_gpp))

bymodel_map <- ggplot() +
  geom_raster(
    data = havealook,
    aes(x = lon, y = lat, fill = l_npp_gpp),
    show.legend = TRUE
    ) +
  geom_sf(
    data = coast,
    colour = 'black',
    linewidth = 0.3
  )  +
  coord_sf(
    ylim = c(-60, 85),
    expand = FALSE
  ) +
  khroma::scale_fill_vik(
    name = "",
    limits = c(0,2), 
    midpoint = 1
    ) +
  theme_void() +
  labs(
    title = expression(paste(italic(L)[NPP/GPP])) 
  ) +
  facet_wrap(. ~ modl, ncol = 3)

ggsave(bymodel_map,filename = here("fig/Spatial_MAP_dnpp_dgpp_trendyv11_bymodel.pdf"),height=10, width = 10)


mean_map <- ggplot() +
	  geom_raster(
	    data = havealook_spatial_map,
	    aes(x = lon, y = lat, fill = l_npp_gpp),
	    show.legend = TRUE
	    ) +
    geom_sf(
      data = coast,
      colour = 'black',
      linewidth = 0.3
    )  +
    coord_sf(
      ylim = c(-60, 85),
      expand = FALSE
    ) +
    khroma::scale_fill_vik(
      reverse=TRUE,
      name = "",
     limits = c(0.2,1.8),  
    midpoint = 1
      ) +
    theme_void() +
    labs(
      title = expression(paste(bold('(c)  '),italic(L)[NPP/GPP],'  as Mean across models')) 
    )

sd_map <- ggplot() +
	  geom_raster(
	    data = havealook_spatial_map,
	    aes(x = lon, y = lat, fill = l_npp_gpp_sd),
	    show.legend = TRUE
	    ) +
    geom_sf(
      data = coast,
      colour = 'black',
      linewidth = 0.3
    )  +
    coord_sf(
      ylim = c(-60, 85),
      expand = FALSE
    ) +
    khroma::scale_fill_YlOrBr(
      name = "",
    limits = c(0,0.8), 
    midpoint = 0.4
      ) +
    theme_void() +
    labs(
      title = expression(paste(bold('(d)  '),italic(L)[NPP/GPP],'  as SD across models')) 
    )

cowplot::plot_grid(
  mean_map, 
  sd_map,
  nrow = 2
)

ggsave(filename = here("fig/Spatial_MAP_dgpp_dnpp_trendyv11.pdf"),height=4, width = 9)
```

### cVeg -> cRoot 

#### All models pooled

```{r}

# all models pooled
gg1 <- gdf %>%
  mutate(data = purrr::map(data, ~slice_sample(., n = nsample))) %>%
  unnest(data) %>%
  dplyr::filter(!is.nan(dCroot), !is.nan(dcveg), !is.infinite(dCroot), !is.infinite(dcveg)) %>%
  ggplot(aes(x = dcveg, y = dCroot)) +
  geom_hex(bins = 50, show.legend = FALSE) +
  theme_classic() +
  geom_abline(intercept = 0, slope = 1, linetype = "dotted") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  khroma::scale_fill_batlowW(trans = "log", reverse = TRUE) +
  xlim(-1, 2) + 
  ylim(-1, 2) +
  labs(
    y = expression(paste(Delta, italic(C)[root], "/", italic(C)[root])),
    x = expression(paste(Delta, italic(C)[veg], "/", italic(C)[veg]))
  )

supernice_gdf<-gdf %>%
  mutate(data = purrr::map(data, ~slice_sample(., n = nsample))) %>%
  unnest(data)%>%
   dplyr::filter(!is.nan(dCroot), !is.nan(dcveg), !is.infinite(dCroot), !is.infinite(dcveg)) %>%
  filter(l_croot_cveg<100000, l_croot_cveg>-1000000) 



# Lables for Histogram  
Labels <- supernice_gdf%>%
  ungroup()%>%
  mutate(l_larger_than_one = l_croot_cveg>1) %>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)


gg2 <- gdf %>%
  mutate(data = purrr::map(data, ~slice_sample(., n = nsample))) %>%
  unnest(data) %>% 
  ggplot(aes(x = l_croot_cveg, y = ..density..)) +
  geom_density(fill = "grey70") +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1, 2.5) + 
      geom_text(data = Labels,aes(x=-Inf, y = Inf,label=percentage_smaller_than_one),hjust = -2, vjust= 1.5)+
  geom_text(data = Labels,aes(x=Inf, y = Inf,label=percentage_larger_than_one),hjust = 3,vjust= 1.5)+
  labs(
    x = expression(paste(italic(L)[Croot/Cveg]))
  )

cowplot::plot_grid(
  gg1, 
  gg2,
  ncol = 2,labels =c('(a)','(b)')
)

ggsave(here("fig/dcveg_dcroot_trendy_s1_pooled.pdf"), width = 8, height = 4)

```


#### All models seperately

```{r}
set.seed(1982)

## all models separately (facet_grid)
nice_gdf  <- gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = nsample))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dCroot), !is.nan(dcveg), !is.infinite(dCroot), !is.infinite(dcveg)) %>%
  filter(l_croot_cveg<100000, l_croot_cveg>-1000000) # to remove NA and infinite


nice_gdf %>%
  ggplot(aes(x = dcveg, y = dCroot)) +
  geom_hex(bins = 50, show.legend = FALSE) +
  theme_classic() +
  geom_abline(intercept = 0, slope = 1, linetype = "dotted") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  khroma::scale_fill_batlowW(trans = "log", reverse = TRUE) +
  xlim(-1, 2) + 
  ylim(-1, 2) +
  labs(
    y = expression(paste(Delta, italic(C)[root], "/", italic(C)[root])),
    x = expression(paste(Delta, italic(C)[veg], "/", italic(C)[veg]))
  )+
  facet_wrap(. ~ modl,  ncol = 3,  scales = "free") +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(size = 12, hjust = 0)
    )


ggsave(here("fig/dcveg_dcroot_trendy_s1_bymodl.pdf"), width = 9, height = 10)



## histograms by model




# we need to get some stat for the overall excel table
Quantile_result <- nice_gdf%>%
    bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = nsample,replace=T))) %>% # smallest set here
      unnest(data) %>%
      filter(modl %in% c('CLASSIC','IBIS','LPJ', "VISIT" ,  "VISIT-NIES", "ISBA-CTRIP"))%>%
      mutate(modl = "C only models")
  ) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = nsample,replace=T))) %>% # smallest set here
      unnest(data) %>%
      filter(!modl %in% c('CLASSIC','IBIS','LPJ', "VISIT" ,  "VISIT-NIES", "ISBA-CTRIP"))%>%
      mutate(modl = "CN coupled models")
  ) %>%
  group_by(modl) %>%
  summarise(l_croot_cveg_50 = quantile(l_croot_cveg,probs=0.5,na.rm=T),
            l_croot_cveg_25 = quantile(l_croot_cveg,probs=0.25,na.rm=T),
            l_croot_cveg_75 = quantile(l_croot_cveg,probs=0.75,na.rm=T)) 
summary_table <- left_join(summary_table,Quantile_result,by='modl')
openxlsx::write.xlsx(summary_table,file = here("fig/TRENDYV11_summarytablev2.xlsx"))
# Lables for Histogram  
Labels <- nice_gdf%>%
  mutate(l_larger_than_one = l_croot_cveg>1) %>%
  group_by(modl) %>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)


nice_gdf %>%
ggplot() +
  geom_density(aes(x = l_croot_cveg, y = ..density..),fill = "grey70") +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1, 2.5) +
  geom_text(data = Labels,aes(x=-Inf, y = Inf,label=percentage_smaller_than_one),hjust = -2, vjust= 1.5)+
  geom_text(data = Labels,aes(x=Inf, y = Inf,label=percentage_larger_than_one),hjust = 3,vjust= 1.5)+
  labs(
       x = expression(paste(italic(L)[Croot/Cveg]))
  )+
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") 

ggsave(here("fig/hist_dcveg_dcroot_trendy_bymodl.pdf"), width = 9, height = 10.5)
```

#### Spatial maps

```{r}

havealook <- gdf %>% #Prepare the dataset, this is similar to the histogram above
  unnest(data)  %>%
  dplyr::filter(!is.nan(dCroot), !is.nan(dcveg), !is.infinite(dCroot), !is.infinite(dcveg)) %>%
  filter(l_croot_cveg<100000, l_croot_cveg>-1000000) %>% # to remove NA and infinite
  mutate(lon=ifelse(lon>180,lon-360,lon)) #some maps have longitude from 0 to 360, need to convert to -180 to 180


havealook_spatial_map <- havealook%>%
filter(!modl=='ALL') %>%
  mutate(lon=floor(lon/2)*2,lat=floor(lat/2)*2) %>%
    mutate(l_croot_cveg=ifelse(l_croot_cveg>2,2,l_croot_cveg),
         l_croot_cveg=ifelse(l_croot_cveg<0,0,l_croot_cveg)) %>%
  group_by(lon,lat,modl) %>%
  summarise(l_croot_cveg=median(l_croot_cveg)) %>%
  group_by(lon,lat) %>%
   summarise(l_croot_cveg_sd=sd(l_croot_cveg),
             l_croot_cveg=mean(l_croot_cveg))

bymodel_map <- ggplot() +
  geom_raster(
    data = havealook,
    aes(x = lon, y = lat, fill = l_croot_cveg),
    show.legend = TRUE
    ) +
  geom_sf(
    data = coast,
    colour = 'black',
    linewidth = 0.3
  )  +
  coord_sf(
    ylim = c(-60, 85),
    expand = FALSE
  ) +
  khroma::scale_fill_vik(
    name = "",
    limits = c(0,2), 
    midpoint = 1
    ) +
  theme_void() +
  labs(
      title = expression(paste(italic(L)[Croot/Cveg],'  as Mean across models')) 
  ) +
  facet_wrap(. ~ modl, ncol = 3)

ggsave(bymodel_map,filename = here("fig/Spatial_MAP_dcroot_dcveg_trendyv11_bymodel.pdf"),height=10, width = 10)

mean_map <- ggplot() +
	  geom_raster(
	    data = havealook_spatial_map,
	    aes(x = lon, y = lat, fill = l_croot_cveg),
	    show.legend = TRUE
	    ) +
    geom_sf(
      data = coast,
      colour = 'black',
      linewidth = 0.3
    )  +
    coord_sf(
      ylim = c(-60, 85),
      expand = FALSE
    ) +
    khroma::scale_fill_vik(
      reverse=TRUE,
      name = "",
    limits = c(0.2,1.8),  
    midpoint = 1
      ) +
    theme_void() +
    labs(
      title = expression(paste(bold('(c)  '),italic(L)[Croot/Cveg],'  as Mean across models')) 
    )

sd_map <- ggplot() +
	  geom_raster(
	    data = havealook_spatial_map,
	    aes(x = lon, y = lat, fill = l_croot_cveg_sd),
	    show.legend = TRUE
	    ) +
    geom_sf(
      data = coast,
      colour = 'black',
      linewidth = 0.3
    )  +
    coord_sf(
      ylim = c(-60, 85),
      expand = FALSE
    ) +
    khroma::scale_fill_YlOrBr(
      name = "",
    limits = c(0,0.8), 
    midpoint = 0.4
      ) +
    theme_void() +
    labs(
      title = expression(paste(bold('(d)  '),italic(L)[Croot/Cveg],'  as SD across models')) 
    )

cowplot::plot_grid(
  mean_map, 
  sd_map,
  nrow = 2
)

ggsave(filename = here("fig/Spatial_MAP_dcveg_dcroot_trendyv11.pdf"),height=4, width = 9)
```


### cLeaf -> cRoot 

#### All models pooled

```{r}

# all models pooled
gg1 <- gdf %>%
  mutate(data = purrr::map(data, ~slice_sample(., n = nsample))) %>%
  unnest(data) %>%
  dplyr::filter(!is.nan(dCroot), !is.nan(dcleaf), !is.infinite(dCroot), !is.infinite(dcleaf)) %>%
  ggplot(aes(x = dcleaf, y = dCroot)) +
  geom_hex(bins = 50, show.legend = FALSE) +
  theme_classic() +
  geom_abline(intercept = 0, slope = 1, linetype = "dotted") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  khroma::scale_fill_batlowW(trans = "log", reverse = TRUE) +
  xlim(-1, 2) + 
  ylim(-1, 2) +
  labs(
    y = expression(paste(Delta, italic(C)[root], "/", italic(C)[root])),
    x = expression(paste(Delta, italic(C)[leaf], "/", italic(C)[leaf]))
  )

supernice_gdf<-gdf %>%
  mutate(data = purrr::map(data, ~slice_sample(., n = nsample))) %>%
  unnest(data)%>%
  dplyr::filter(!is.nan(dCroot), !is.nan(dcleaf), !is.infinite(dCroot), !is.infinite(dcleaf)) %>%
  mutate(l_croot_cleaf = dCroot/ dcleaf)%>%
  filter(l_croot_cleaf<100000, l_croot_cleaf>-1000000) 



# Lables for Histogram  
Labels <- supernice_gdf%>%
  ungroup()%>%
  mutate(l_larger_than_one = l_croot_cleaf>1) %>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)


gg2 <- supernice_gdf %>% 
  ggplot(aes(x = l_croot_cleaf, y = ..density..)) +
  geom_density(fill = "grey70") +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1, 2.5) + 
      geom_text(data = Labels,aes(x=-Inf, y = Inf,label=percentage_smaller_than_one),hjust = -2, vjust= 1.5)+
  geom_text(data = Labels,aes(x=Inf, y = Inf,label=percentage_larger_than_one),hjust = 3,vjust= 1.5)+
  labs(
    x = expression(paste(italic(L)[Croot/Cleaf]))
  )

cowplot::plot_grid(
  gg1, 
  gg2,
  ncol = 2
)

ggsave(here("fig/dcleaf_dcroot_trendy_s1_pooled.pdf"), width = 8, height = 4)

```


#### All models seperately

```{r}
set.seed(1982)

## all models separately (facet_grid)
nice_gdf  <- gdf %>%
  unnest(data) %>%
  bind_rows(
    .,
    gdf %>%
      mutate(n = purrr::map_int(data, ~nrow(.))) %>%
      mutate(data = purrr::map(data, ~slice_sample(., n = nsample))) %>% # smallest set here
      unnest(data) %>%
      mutate(modl = "ALL")
  ) %>%
  dplyr::filter(!is.nan(dCroot), !is.nan(dcleaf), !is.infinite(dCroot), !is.infinite(dcleaf)) %>%
  mutate(l_croot_cleaf = dCroot/ dcleaf)%>%
  filter(l_croot_cleaf<100000, l_croot_cleaf>-1000000) 


nice_gdf %>%
  ggplot(aes(x = dcleaf, y = dCroot)) +
  geom_hex(bins = 50, show.legend = FALSE) +
  theme_classic() +
  geom_abline(intercept = 0, slope = 1, linetype = "dotted") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  khroma::scale_fill_batlowW(trans = "log", reverse = TRUE) +
  xlim(-1, 2) + 
  ylim(-1, 2) +
  labs(
    y = expression(paste(Delta, italic(C)[root], "/", italic(C)[root])),
    x = expression(paste(Delta, italic(C)[leaf], "/", italic(C)[leaf]))
  )+
  facet_wrap(. ~ modl,  ncol = 3,  scales = "free") +
  theme(
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(size = 12, hjust = 0)
    )


ggsave(here("fig/dcleaf_dcroot_trendy_s1_bymodl.pdf"), width = 9, height = 10)



## histograms by model


# we need to get some stat for the overall excel table
Quantile_result <- nice_gdf%>%
  group_by(modl) %>%
  summarise(l_croot_cleaf_50 = quantile(l_croot_cleaf,probs=0.5)) 
summary_table <- left_join(summary_table,Quantile_result,by='modl')
#openxlsx::write.xlsx(summary_table,file = here("fig/TRENDYV11_summarytable.xlsx"))
# Lables for Histogram  
Labels <- nice_gdf%>%
  mutate(l_larger_than_one = l_croot_cleaf>1) %>%
  group_by(modl) %>%
  summarise(number_of_records=n(),
            percentage_larger_than_one = round(sum(l_larger_than_one)/number_of_records,digits =2),
            percentage_smaller_than_one = 1-percentage_larger_than_one)


nice_gdf %>%
ggplot() +
  geom_density(aes(x = l_croot_cleaf, y = ..density..),fill = "grey70") +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 1, linetype = "dotted") +
  xlim(-1, 2.5) +
  geom_text(data = Labels,aes(x=-Inf, y = Inf,label=percentage_smaller_than_one),hjust = -2, vjust= 1.5)+
  geom_text(data = Labels,aes(x=Inf, y = Inf,label=percentage_larger_than_one),hjust = 3,vjust= 1.5)+
  labs(
       x = expression(paste(italic(L)[Croot/Cleaf]))
  )+
  facet_wrap(. ~ modl, ncol = 3,  scales = "free") 

ggsave(here("fig/hist_dcleaf_dcroot_trendy_bymodl.pdf"), width = 9, height = 10.5)
```

